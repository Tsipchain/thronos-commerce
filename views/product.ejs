<!DOCTYPE html>
<html lang="<%= lang %>">
  <head>
    <meta charset="UTF-8" />
    <title><%= product.name %> â€“ <%= config.storeName %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="/favicon.ico" />
    <link rel="stylesheet" href="/styles.css" />
    <% if (product.seoTitle) { %><meta name="og:title" content="<%= product.seoTitle %>" /><% } %>
    <% if (product.seoDescription) { %><meta name="description" content="<%= product.seoDescription %>" /><% } %>
    <style>
      :root {
        --primary-color: <%= config.primaryColor %>;
        --accent-color:  <%= config.accentColor %>;
        --font-family:   <%= config.fontFamily %>;
        --menu-bg:         <%= (config.theme && config.theme.menuBg)         || '#111' %>;
        --menu-text:       <%= (config.theme && config.theme.menuText)       || '#fff' %>;
        --menu-active-bg:  <%= (config.theme && config.theme.menuActiveBg)   || '#f06292' %>;
        --menu-active-text:<%= (config.theme && config.theme.menuActiveText) || '#fff' %>;
        --button-radius:   <%= (config.theme && config.theme.buttonRadius)   || '4px' %>;
      }

      /* â”€â”€ Hero image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .product-hero-image {
        overflow: hidden; border-radius: 10px; cursor: zoom-in;
        display: inline-block; max-width: 100%;
      }
      .product-hero-image img {
        display: block; max-width: 100%; max-height: 420px;
        object-fit: contain; border-radius: 10px;
        transition: transform .3s ease, opacity .15s;
      }
      .product-hero-image:hover img { transform: scale(1.08); }

      /* â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #lightbox {
        display: none; position: fixed; inset: 0; z-index: 1100;
        background: rgba(0,0,0,.85); align-items: center; justify-content: center;
      }
      #lightbox.open { display: flex; }
      #lightbox img {
        max-width: 92vw; max-height: 88vh; object-fit: contain;
        border-radius: 8px; box-shadow: 0 8px 40px rgba(0,0,0,.5);
      }
      #lightbox-close {
        position: absolute; top: 20px; right: 28px;
        color: #fff; font-size: 2.2rem; cursor: pointer; line-height: 1;
        background: none; border: none; padding: 0;
      }

      /* â”€â”€ Thumbnails â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .gallery-thumbs { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
      .gallery-thumbs img {
        width: 72px; height: 72px; object-fit: cover; border-radius: 4px;
        cursor: pointer; border: 2px solid transparent; transition: border-color .15s;
      }
      .gallery-thumbs img:hover, .gallery-thumbs img.active { border-color: var(--accent-color); }

      /* â”€â”€ Stock badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .stock-badge {
        display: inline-block; padding: 3px 10px; border-radius: 20px;
        font-size: .8rem; font-weight: 600; margin: 4px 0 12px;
      }
      .stock-badge.ok  { background: #d1fae5; color: #065f46; }
      .stock-badge.low { background: #fef3c7; color: #92400e; }
      .stock-badge.out { background: #fee2e2; color: #991b1b; }

      /* â”€â”€ Add to Cart button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .btn-add-cart {
        display: inline-flex; align-items: center; gap: 8px;
        background: var(--primary-color, #4f46e5); color: #fff;
        border: none; border-radius: var(--button-radius, 4px);
        padding: 12px 26px; font-size: 1rem; font-weight: 600;
        cursor: pointer; margin-top: 10px;
        transition: opacity .15s, transform .1s;
      }
      .btn-add-cart:hover:not(:disabled) { opacity: .88; }
      .btn-add-cart:active:not(:disabled) { transform: scale(.96); }
      .btn-add-cart:disabled { opacity: .45; cursor: not-allowed; }

      /* â”€â”€ Specs table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .specs-table {
        width: 100%; border-collapse: collapse; margin: 18px 0;
        font-size: .88rem;
      }
      .specs-table th, .specs-table td {
        padding: 7px 12px; border: 1px solid #e5e7eb; text-align: left;
      }
      .specs-table th {
        background: #f9fafb; width: 38%; font-weight: 600; color: #374151;
      }

      /* â”€â”€ Variant selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .variant-selector { margin: 14px 0 4px; }
      .variant-selector > p { font-size: .88rem; font-weight: 600; color: #374151; margin: 0 0 8px; }
      .variant-pills { display: flex; flex-wrap: wrap; gap: 8px; }
      .variant-pill {
        padding: 7px 18px; border-radius: 20px; border: 2px solid #e5e7eb;
        background: #fff; cursor: pointer; font-size: .88rem; font-weight: 500;
        transition: border-color .15s, background .15s, color .15s;
        line-height: 1.3;
      }
      .variant-pill:hover:not(:disabled) { border-color: var(--primary-color, #4f46e5); }
      .variant-pill.selected {
        border-color: var(--primary-color, #4f46e5);
        background: var(--primary-color, #4f46e5); color: #fff;
      }
      .variant-pill:disabled { opacity: .4; cursor: not-allowed; }

      /* â”€â”€ Reviews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .reviews-section { margin-top: 36px; }
      .review-card {
        border-bottom: 1px solid #eee; padding: 12px 0;
      }
      .review-card .rv-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
      .rv-stars { color: #f59e0b; }
      .rv-date  { color: #aaa; font-size: .78rem; }
      .rv-comment { font-size: .88rem; margin: 4px 0 0; }
      .review-gate {
        background: #f9fafb; border-radius: 8px; padding: 18px 20px; margin-top: 16px;
      }
      .review-gate input, .review-gate textarea, .review-gate select {
        width: 100%; margin-top: 4px; padding: 7px 10px;
        border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;
      }
      .review-gate label { display: block; margin-bottom: 10px; font-size: .9rem; }
    </style>
    <%
      const _offers = [];
      if (Array.isArray(product.variants) && product.variants.length) {
        product.variants.forEach(function(v) {
          _offers.push({
            "@type": "Offer",
            "name": v.label,
            "price": (Number(v.price) || 0).toFixed(2),
            "priceCurrency": "EUR",
            "availability": (v.stock === 0) ? "https://schema.org/OutOfStock" : "https://schema.org/InStock"
          });
        });
      } else {
        _offers.push({
          "@type": "Offer",
          "price": (Number(product.price) || 0).toFixed(2),
          "priceCurrency": "EUR",
          "availability": (product.stock === 0) ? "https://schema.org/OutOfStock" : "https://schema.org/InStock"
        });
      }
      const _ldJson = {
        "@context": "https://schema.org/",
        "@type": "Product",
        "name": product.name,
        "description": product.description || product.seoDescription || '',
        "sku": product.sku || '',
        "image": product.imageUrl || '',
        "brand": { "@type": "Brand", "name": config.storeName },
        "offers": _offers.length === 1 ? _offers[0] : _offers
      };
    %>
    <script type="application/ld+json"><%- JSON.stringify(_ldJson, null, 2) %></script>
  </head>
  <body>
    <header>
      <div class="logo-title">
        <% if (config.logoPath) { %>
          <img src="<%= config.logoPath %>" alt="<%= config.storeName %>" class="logo" />
        <% } %>
        <a href="/" style="text-decoration:none;color:inherit;"><h1><%= config.storeName %></h1></a>
      </div>
    </header>

    <main>
      <a href="/" style="display:inline-flex;align-items:center;gap:6px;font-size:.86rem;color:var(--primary-color,#4f46e5);text-decoration:none;margin-bottom:14px;opacity:.85;">
        <%= t('checkout.backToStore') %>
      </a>
      <article class="product-detail">

        <%# â”€â”€ Hero image + lightbox trigger â”€â”€ %>
        <% const allImgs = [product.imageUrl].concat(Array.isArray(product.gallery) ? product.gallery : []).filter(Boolean); %>
        <% if (allImgs.length) { %>
          <div class="product-hero-image" onclick="openLightbox('<%= allImgs[0] %>')" id="hero-wrap">
            <img src="<%= allImgs[0] %>" alt="<%= product.name %>" id="hero-img" />
          </div>
          <% if (allImgs.length > 1) { %>
          <div class="gallery-thumbs">
            <% allImgs.forEach(function(url, gi) { %>
              <img src="<%= url %>" alt="" loading="lazy" class="<%= gi === 0 ? 'active' : '' %>"
                   onclick="swapHero(this, '<%= url %>')" />
            <% }) %>
          </div>
          <% } %>
        <% } %>

        <%# â”€â”€ Product info â”€â”€ %>
        <h2><%= product.name %></h2>
        <% if (product.sku) { %><p style="color:#888;font-size:.82rem;margin:-6px 0 6px;">SKU: <%= product.sku %></p><% } %>

        <% if (product.stock !== undefined) { %>
          <p id="stock-badge" class="stock-badge <%= product.stock === 0 ? 'out' : product.stock < 3 ? 'low' : 'ok' %>">
            <% if (product.stock === 0) { %><%= t('checkout.stockOut') %>
            <% } else if (product.stock < 3) { %><%= t('checkout.stockLow') %> (<%= product.stock %>)
            <% } else { %><%= t('checkout.inStock') %><% } %>
          </p>
        <% } else { %>
          <p id="stock-badge" class="stock-badge ok" style="display:none;"></p>
        <% } %>

        <p class="price"><span id="product-price"><%= Number(product.price).toFixed(2) %></span> â‚¬</p>

        <%# â”€â”€ Variant selector â”€â”€ %>
        <% if (Array.isArray(product.variants) && product.variants.length) { %>
          <div class="variant-selector">
            <p><%= t('product.variantsTitle') %>: <strong id="variant-label"><%= product.variants[0].label %></strong></p>
            <div class="variant-pills">
              <% product.variants.forEach(function(v, vi) { %>
                <button class="variant-pill <%= vi === 0 ? 'selected' : '' %>"
                        data-vid="<%= v.id %>"
                        <%= v.stock === 0 ? 'disabled' : '' %>
                        onclick="selectVariant(this)">
                  <%= v.label %>
                  <% if (Number(v.price) !== Number(product.price)) { %>
                    <span style="font-size:.76rem;opacity:.82;"> &ndash; <%= Number(v.price).toFixed(2) %> &euro;</span>
                  <% } %>
                </button>
              <% }) %>
            </div>
          </div>
        <% } %>

        <% if (product.description) { %>
          <p class="product-description"><%= product.description %></p>
        <% } %>

        <%# â”€â”€ Technical specs â”€â”€ %>
        <% const specs = Array.isArray(product.specs) ? product.specs.filter(function(s){ return s.k && s.v; }) : []; %>
        <% if (specs.length) { %>
          <h3 style="margin-top:22px;margin-bottom:8px;font-size:1rem;"><%= t('product.specsTitle') %></h3>
          <table class="specs-table">
            <tbody>
              <% specs.forEach(function(s) { %>
                <tr><th><%= s.k %></th><td><%= s.v %></td></tr>
              <% }) %>
            </tbody>
          </table>
        <% } %>

        <%# â”€â”€ Digital content preview â”€â”€ %>
        <% if (product.hasDigitalContent) { %>
          <input type="hidden" id="has-manual" value="<%= product.manualUrl ? '1' : '' %>" />
          <div id="content-preview" style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:16px 20px;margin:18px 0;<%= (product.manualUrl || product.videoUrl || product.contentDescription) ? '' : 'display:none' %>">
            <p style="margin:0 0 8px;font-weight:700;color:#15803d;font-size:.95rem;">ğŸ <%= t('product.contentIncluded') %></p>
            <% if (product.contentDescription) { %>
              <p style="margin:0 0 8px;font-size:.86rem;color:#166534;"><%= product.contentDescription %></p>
            <% } %>
            <ul style="margin:0;padding-left:18px;font-size:.83rem;color:#166534;">
              <% if (product.manualUrl) { %><li>ğŸ“„ <%= t('product.contentManual') %></li><% } %>
              <% if (product.videoUrl) { %><li>ğŸ¬ <%= t('product.contentVideo') %></li><% } %>
            </ul>
            <p style="margin:8px 0 0;font-size:.75rem;color:#6b7280;"><%= t('product.contentAfterPurchase') %></p>
          </div>
        <% } %>

        <%# â”€â”€ Add to Cart button â”€â”€ %>
        <button class="btn-add-cart" id="btn-add-cart"
                <%= product.stock === 0 ? 'disabled' : '' %>
                onclick="addThisToCart()">
          ğŸ›’ <%= t('storefront.addToCart') %>
        </button>

      </article>

      <%# â”€â”€ Reviews section â”€â”€ %>
      <section class="reviews-section">
        <h3><%= t('reviews.title') %></h3>
        <div id="reviews-list"></div>

        <div class="review-gate" id="review-gate">
          <p style="margin:0 0 12px;font-size:.88rem;color:#6b7280;"><%= t('reviews.verifiedNote') %></p>
          <label>
            Email Î±Î³Î¿ÏÎ¬Ï‚
            <input type="email" id="rv-email-check" placeholder="Î¤Î¿ email Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ±Ï„Îµ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±" />
          </label>
          <button class="button" type="button" id="rv-verify-btn" onclick="verifyPurchase()" style="margin-top:2px;">
            <%= t('reviews.verifyBtn') %>
          </button>
          <p id="rv-verify-msg" style="font-size:.83rem;margin-top:8px;"></p>
        </div>

        <div id="review-form-wrap" class="review-gate" style="display:none;">
          <h4 style="margin:0 0 14px;"><%= t('reviews.writeReview') %></h4>
          <p id="review-msg" style="font-size:.88rem;margin-bottom:10px;"></p>
          <input type="hidden" id="rv-verified-email" value="" />
          <label>
            <%= t('reviews.labelName') %>
            <input type="text" id="rv-name" />
          </label>
          <label>
            <%= t('reviews.labelRating') %>
            <select id="rv-rating">
              <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
              <option value="4">â˜…â˜…â˜…â˜…â˜†</option>
              <option value="3">â˜…â˜…â˜…â˜†â˜†</option>
              <option value="2">â˜…â˜…â˜†â˜†â˜†</option>
              <option value="1">â˜…â˜†â˜†â˜†â˜†</option>
            </select>
          </label>
          <label>
            <%= t('reviews.labelComment') %>
            <textarea id="rv-comment" rows="3" style="resize:vertical;"></textarea>
          </label>
          <button class="button" id="rv-submit" type="button" onclick="submitReview()"><%= t('reviews.submit') %></button>
        </div>
      </section>
    </main>

    <%# â”€â”€ Lightbox overlay â”€â”€ %>
    <div id="lightbox" onclick="closeLightbox()">
      <button id="lightbox-close" onclick="closeLightbox()" aria-label="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">&times;</button>
      <img id="lightbox-img" src="" alt="" onclick="event.stopPropagation()" />
    </div>

    <%# â”€â”€ Floating cart â”€â”€ %>
    <%- include('_cart') %>

    <script>
      // â”€â”€ Product data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const PRODUCT = {
        id:    '<%= product.id %>',
        name:  '<%- (product.name || '').replace(/'/g, "\\'") %>',
        price: <%= Number(product.price) || 0 %>,
        imageUrl: '<%- (product.imageUrl || '').replace(/'/g, "\\'") %>'
      };
      const VARIANTS = <%- JSON.stringify(Array.isArray(product.variants) ? product.variants : []) %>;
      const HAS_DIGITAL = <%= product.hasDigitalContent ? 'true' : 'false' %>;
      const BASE_MANUAL  = '<%= product.manualUrl ? '1' : '' %>';
      const BASE_VIDEO   = '<%- (product.videoUrl || '').replace(/'/g, "\\'") %>';
      const BASE_DESC    = '<%- (product.contentDescription || '').replace(/'/g, "\\'").replace(/\n/g, ' ') %>';
      const STOCK_OUT    = '<%= t("checkout.stockOut") %>';
      const STOCK_LOW    = '<%= t("checkout.stockLow") %>';
      const IN_STOCK     = '<%= t("checkout.inStock") %>';

      let selectedVariant = VARIANTS.length ? VARIANTS[0] : null;

      // â”€â”€ Variant selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function selectVariant(btn) {
        document.querySelectorAll('.variant-pill').forEach(function(b) { b.classList.remove('selected'); });
        btn.classList.add('selected');
        const vid = btn.dataset.vid;
        const v   = VARIANTS.find(function(vv) { return vv.id === vid; });
        if (!v) return;
        selectedVariant = v;

        // Update label
        const lbl = document.getElementById('variant-label');
        if (lbl) lbl.textContent = v.label;

        // Update price
        const priceEl = document.getElementById('product-price');
        if (priceEl) priceEl.textContent = (Number(v.price) || PRODUCT.price).toFixed(2);

        // Update stock badge
        const stock = (v.stock !== undefined) ? Number(v.stock) : -1;
        updateStockBadge(stock);

        // Update add-to-cart disabled state
        const btnCart = document.getElementById('btn-add-cart');
        if (btnCart) btnCart.disabled = (Number(v.stock) === 0);

        // Update digital content preview
        if (HAS_DIGITAL) {
          updateContentPreview(
            v.videoUrl  || BASE_VIDEO,
            v.contentDescription || BASE_DESC,
            BASE_MANUAL
          );
        }
      }

      function updateStockBadge(stock) {
        const badge = document.getElementById('stock-badge');
        if (!badge) return;
        if (stock < 0) { badge.style.display = 'none'; return; }
        badge.style.display = '';
        if (stock === 0) {
          badge.className = 'stock-badge out';
          badge.textContent = STOCK_OUT;
        } else if (stock < 3) {
          badge.className = 'stock-badge low';
          badge.textContent = STOCK_LOW + ' (' + stock + ')';
        } else {
          badge.className = 'stock-badge ok';
          badge.textContent = IN_STOCK;
        }
      }

      function updateContentPreview(videoUrl, desc, hasManual) {
        const box = document.getElementById('content-preview');
        if (!box) return;
        const hasVideo = !!videoUrl;
        if (!hasManual && !hasVideo && !desc) { box.style.display = 'none'; return; }
        box.style.display = '';
        let html = '<p style="margin:0 0 8px;font-weight:700;color:#15803d;font-size:.95rem;">ğŸ <%= t("product.contentIncluded") %></p>';
        if (desc) html += '<p style="margin:0 0 8px;font-size:.86rem;color:#166534;">' + desc.replace(/</g,'&lt;') + '</p>';
        html += '<ul style="margin:0;padding-left:18px;font-size:.83rem;color:#166534;">';
        if (hasManual) html += '<li>ğŸ“„ <%= t("product.contentManual") %></li>';
        if (hasVideo)  html += '<li>ğŸ¬ <%= t("product.contentVideo") %></li>';
        html += '</ul>';
        html += '<p style="margin:8px 0 0;font-size:.75rem;color:#6b7280;"><%= t("product.contentAfterPurchase") %></p>';
        box.innerHTML = html;
      }

      // â”€â”€ Add to Cart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function addThisToCart() {
        if (typeof window.thrcAddToCart !== 'function') return;
        const p = {
          id:       PRODUCT.id,
          name:     PRODUCT.name,
          price:    selectedVariant ? (Number(selectedVariant.price) || PRODUCT.price) : PRODUCT.price,
          imageUrl: PRODUCT.imageUrl
        };
        if (selectedVariant) {
          p.variantId    = selectedVariant.id;
          p.variantLabel = selectedVariant.label;
        }
        window.thrcAddToCart(p);
      }

      // â”€â”€ Gallery swap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function swapHero(thumb, url) {
        const hero = document.getElementById('hero-img');
        const wrap = document.getElementById('hero-wrap');
        if (hero) { hero.src = url; }
        if (wrap) { wrap.onclick = function() { openLightbox(url); }; }
        document.querySelectorAll('.gallery-thumbs img').forEach(function(t) { t.classList.remove('active'); });
        thumb.classList.add('active');
      }

      // â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function openLightbox(url) {
        const lb = document.getElementById('lightbox');
        document.getElementById('lightbox-img').src = url;
        lb.classList.add('open');
        document.body.style.overflow = 'hidden';
      }
      function closeLightbox() {
        document.getElementById('lightbox').classList.remove('open');
        document.body.style.overflow = '';
      }
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeLightbox();
      });

      // â”€â”€ Reviews â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const PRODUCT_ID = '<%= product.id %>';
      const STARS = ['', 'â˜…â˜†â˜†â˜†â˜†', 'â˜…â˜…â˜†â˜†â˜†', 'â˜…â˜…â˜…â˜†â˜†', 'â˜…â˜…â˜…â˜…â˜†', 'â˜…â˜…â˜…â˜…â˜…'];

      function renderReviews(list) {
        const el = document.getElementById('reviews-list');
        if (!list.length) {
          el.innerHTML = '<p style="color:#aaa;font-style:italic;font-size:.86rem;"><%= t("reviews.noReviews") %></p>';
          return;
        }
        el.innerHTML = list.slice(-20).reverse().map(function(r) {
          const d = new Date(r.createdAt).toLocaleDateString('<%= lang %>');
          const verified = r.verified ? '<span style="color:#059669;font-size:.75rem;margin-left:6px;">âœ“ Î•Ï€Î±Î»Î·Î¸ÎµÏ…Î¼Î­Î½Î· Î±Î³Î¿ÏÎ¬</span>' : '';
          return '<div class="review-card">' +
            '<div class="rv-meta"><strong>' + (r.name || '').replace(/</g,'&lt;') + '</strong>' +
            verified +
            '<span class="rv-stars">' + (STARS[r.rating] || r.rating) + '</span>' +
            '<span class="rv-date">' + d + '</span></div>' +
            '<p class="rv-comment">' + (r.comment || '').replace(/</g,'&lt;') + '</p>' +
            '</div>';
        }).join('');
      }

      fetch('/api/products/' + PRODUCT_ID + '/reviews')
        .then(function(r) { return r.json(); }).then(renderReviews).catch(function(){});

      // â”€â”€ Verified purchase gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function verifyPurchase() {
        const email = (document.getElementById('rv-email-check').value || '').trim();
        const msg   = document.getElementById('rv-verify-msg');
        if (!email) { msg.style.color = '#dc2626'; msg.textContent = 'Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ email.'; return; }
        msg.style.color = '#6b7280'; msg.textContent = 'ÎˆÎ»ÎµÎ³Ï‡Î¿Ï‚...';
        fetch('/api/products/' + PRODUCT_ID + '/can-review?email=' + encodeURIComponent(email))
          .then(function(r) { return r.json(); })
          .then(function(data) {
            if (data.canReview) {
              document.getElementById('rv-verified-email').value = email;
              document.getElementById('review-gate').style.display = 'none';
              document.getElementById('review-form-wrap').style.display = '';
            } else {
              msg.style.color = '#dc2626';
              msg.textContent = '<%= t("reviews.notVerified") %>';
            }
          })
          .catch(function() { msg.style.color='#dc2626'; msg.textContent='Î£Ï†Î¬Î»Î¼Î± ÎµÎ»Î­Î³Ï‡Î¿Ï….'; });
      }

      function submitReview() {
        const name    = (document.getElementById('rv-name').value    || '').trim();
        const comment = (document.getElementById('rv-comment').value || '').trim();
        const rating  = document.getElementById('rv-rating').value;
        const email   = document.getElementById('rv-verified-email').value;
        const msgEl   = document.getElementById('review-msg');
        msgEl.textContent = '';
        fetch('/api/products/' + PRODUCT_ID + '/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, rating, comment, email })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.ok) {
            msgEl.style.color = '#155724';
            msgEl.textContent = '<%= t("reviews.submitOk") %>';
            document.getElementById('rv-name').value = '';
            document.getElementById('rv-comment').value = '';
            fetch('/api/products/' + PRODUCT_ID + '/reviews')
              .then(function(r) { return r.json(); }).then(renderReviews);
          } else {
            msgEl.style.color = '#721c24';
            msgEl.textContent = data.error || '<%= t("reviews.submitErr") %>';
          }
        })
        .catch(function() { msgEl.style.color='#721c24'; msgEl.textContent='<%= t("reviews.submitErr") %>'; });
      }
    </script>
  </body>
</html>
