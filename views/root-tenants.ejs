<!DOCTYPE html>
<html lang="<%= lang %>">
  <head>
    <meta charset="UTF-8" />
    <title>Thronos Root Admin â€“ Tenants</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <style>
      :root {
        --accent-color: #5b6af5;
        --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      body { font-family: var(--font-family); background: #f4f6fb; color: #1a1a2e; margin: 0; }

      header {
        background: #1a1a2e; color: #fff; padding: 18px 28px;
        display: flex; align-items: baseline; gap: 16px; flex-wrap: wrap;
      }
      header h1 { margin: 0; font-size: 1.2rem; letter-spacing: 0.02em; }
      header .badge {
        background: #5b6af5; color: #fff; border-radius: 4px;
        padding: 2px 10px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.05em;
      }
      header a { color: #a0aec0; font-size: 0.82rem; text-decoration: none; }
      header a:hover { color: #fff; }

      .root-layout { max-width: 1100px; margin: 28px auto; padding: 0 20px 60px; }

      .flash { padding: 12px 18px; border-radius: 6px; margin-bottom: 20px; font-size: 0.9rem; }
      .flash.success { background: #d4edda; border: 1px solid #b8dfc4; color: #155724; }
      .flash.error   { background: #f8d7da; border: 1px solid #f1b0b7; color: #721c24; }

      /* â”€â”€ Section card â”€â”€ */
      .card {
        background: #fff; border-radius: 10px; padding: 24px 28px;
        box-shadow: 0 2px 12px rgba(0,0,0,.07); margin-bottom: 24px;
      }
      .card h2 { margin: 0 0 4px; font-size: 1.05rem; }
      .card .helper { font-size: 0.82rem; color: #666; margin: 0 0 18px; }

      /* â”€â”€ Tenants table â”€â”€ */
      .tenants-table { width: 100%; border-collapse: collapse; font-size: 0.86rem; }
      .tenants-table th, .tenants-table td {
        padding: 9px 12px; text-align: left; border-bottom: 1px solid #eee;
      }
      .tenants-table th { background: #f0f2fa; font-weight: 600; white-space: nowrap; }
      .tenants-table tr:hover td { background: #fafbff; }

      .tier-badge {
        display: inline-block; padding: 2px 8px; border-radius: 20px;
        font-size: 0.75rem; font-weight: 600; white-space: nowrap;
      }
      .tier-SELF_SERVICE     { background: #e3f0ff; color: #1a56db; }
      .tier-MANAGEMENT_START { background: #fef3c7; color: #92400e; }
      .tier-FULL_OPS_START   { background: #d1fae5; color: #065f46; }

      .active-yes { color: #065f46; font-weight: 600; }
      .active-no  { color: #9f1239; font-weight: 600; }

      /* â”€â”€ Forms â”€â”€ */
      .form-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px; margin-bottom: 16px;
      }
      .form-grid .full { grid-column: 1 / -1; }
      .form-grid label { display: flex; flex-direction: column; gap: 5px;
                         font-size: 0.84rem; font-weight: 500; }
      .form-grid input, .form-grid select {
        padding: 7px 10px; border: 1px solid #d1d5db; border-radius: 6px;
        font-size: 0.88rem; background: #fff;
      }
      .form-grid input:focus, .form-grid select:focus {
        outline: none; border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(91,106,245,.12);
      }
      .form-grid .hint { font-size: 0.76rem; color: #888; margin-top: 2px; }

      .form-actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
      .btn {
        display: inline-block; padding: 8px 20px; border-radius: 6px; font-size: 0.88rem;
        font-weight: 600; cursor: pointer; border: none; transition: opacity .15s;
      }
      .btn:hover { opacity: 0.87; }
      .btn-primary { background: var(--accent-color); color: #fff; }
      .btn-warning { background: #f59e0b; color: #fff; }
      .btn-danger  { background: #ef4444; color: #fff; }

      .root-pass-note {
        font-size: 0.78rem; color: #888;
        border-top: 1px dashed #ddd; margin-top: 20px; padding-top: 14px;
      }

      /* â”€â”€ Collapsible form sections â”€â”€ */
      details { margin-top: 10px; }
      details summary {
        cursor: pointer; font-weight: 600; font-size: 0.92rem;
        color: var(--accent-color); list-style: none; padding: 4px 0;
      }
      details summary::-webkit-details-marker { display: none; }
      details summary::before { content: 'â–¶ '; font-size: 0.7rem; }
      details[open] summary::before { content: 'â–¼ '; font-size: 0.7rem; }
      details .detail-body { padding: 16px 0 4px; }
    </style>
  </head>
  <body>
    <header>
      <h1>Thronos Commerce</h1>
      <span class="badge">ROOT ADMIN</span>
      <span style="flex:1"></span>
      <a href="/">â† Storefront</a>
    </header>

    <div class="root-layout">

      <% if (message) { %>
        <div class="flash success"><%= message %></div>
      <% } %>
      <% if (error) { %>
        <div class="flash error"><%= error %></div>
      <% } %>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   TENANTS TABLE                                           %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Tenants (<%= tenants.length %>)</h2>
        <p class="helper">ÎŒÎ»Î± Ï„Î± ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î± Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÎµÎ³Î³ÎµÎ³ÏÎ±Î¼Î¼Î­Î½Î± ÏƒÏ„Î·Î½ Ï€Î»Î±Ï„Ï†ÏŒÏÎ¼Î±.</p>

        <% if (tenants.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ tenants Î±ÎºÏŒÎ¼Î±.</p>
        <% } else { %>
        <div style="overflow-x:auto;">
          <table class="tenants-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Domain</th>
                <th>Î Î±ÎºÎ­Ï„Î¿</th>
                <th>Referral</th>
                <th>Î•Î½ÎµÏÎ³ÏŒ</th>
                <th>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±</th>
                <th>Admin hash</th>
              </tr>
            </thead>
            <tbody>
              <% tenants.forEach(function(t) { %>
              <tr>
                <td><code><%= t.id %></code></td>
                <td><%= t.domain || 'â€“' %></td>
                <td><span class="tier-badge tier-<%= t.supportTier %>"><%= t.supportTier %></span></td>
                <td style="font-size:0.8rem;">
                  <% if (t.referral && t.referral.code) { %>
                    <code style="background:#f0f2fa;padding:1px 5px;border-radius:3px;"><%= t.referral.code %></code>
                    <span style="color:#888;"> <%= (t.referral.percent * 100).toFixed(0) %>%</span>
                  <% } else { %>
                    <span style="color:#ccc;">â€“</span>
                  <% } %>
                </td>
                <td>
                  <% if (t.active) { %>
                    <span class="active-yes">âœ“ ÎÎ±Î¹</span>
                  <% } else { %>
                    <span class="active-no">âœ— ÎŒÏ‡Î¹</span>
                  <% } %>
                </td>
                <td style="white-space:nowrap;font-size:0.8rem;color:#666;">
                  <% if (t.createdAt) { %>
                    <%= new Date(t.createdAt).toLocaleDateString('el-GR') %>
                  <% } else { %>â€“<% } %>
                </td>
                <td style="font-size:0.74rem;color:#999;font-family:monospace;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                  <%= t.adminPasswordHash ? t.adminPasswordHash.slice(0, 20) + 'â€¦' : 'â€“' %>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } %>
      </div>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   CREATE TENANT                                           %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î¿Ï… tenant</h2>
        <p class="helper">
          Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï„Î¿Ï… Î½Î­Î¿Ï… ÎºÎ±Ï„Î±ÏƒÏ„Î®Î¼Î±Ï„Î¿Ï‚. Î¤Î± Î±ÏÏ‡ÎµÎ¯Î± config/products/categories
          Î¸Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸Î¿ÏÎ½ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î± Î±Ï€ÏŒ Ï„Î¿ template Ï€Î¿Ï… ÎµÏ€Î¹Î»Î­Î¾ÎµÏ„Îµ.
        </p>

        <form method="POST" action="/root/tenants/create">
          <div class="form-grid">
            <label>
              Tenant ID *
              <input type="text" name="id" placeholder="Ï€.Ï‡. myshop" required
                     pattern="[a-zA-Z0-9_-]+" title="ÎœÏŒÎ½Î¿ Î³ÏÎ¬Î¼Î¼Î±Ï„Î±, Î±ÏÎ¹Î¸Î¼Î¿Î¯, _ ÎºÎ±Î¹ -" />
              <span class="hint">ÎœÎ¿Î½Î±Î´Î¹ÎºÏŒ Î±Î½Î±Î³Î½Ï‰ÏÎ¹ÏƒÏ„Î¹ÎºÏŒ (a-z, 0-9, -, _)</span>
            </label>

            <label>
              Domain
              <input type="text" name="domain" placeholder="Ï€.Ï‡. myshop.gr" />
              <span class="hint">Î¤Î¿ hostname Î³Î¹Î± tenant resolution</span>
            </label>

            <label>
              Î Î±ÎºÎ­Ï„Î¿ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚
              <select name="supportTier">
                <option value="SELF_SERVICE">SELF_SERVICE</option>
                <option value="MANAGEMENT_START">MANAGEMENT_START</option>
                <option value="FULL_OPS_START">FULL_OPS_START</option>
              </select>
            </label>

            <label>
              Template (Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î® Î±Ï€ÏŒ)
              <select name="templateId">
                <% tenants.forEach(function(t) { %>
                  <option value="<%= t.id %>" <%= t.id === 'demo' ? 'selected' : '' %>><%= t.id %></option>
                <% }) %>
                <% if (tenants.length === 0) { %>
                  <option value="demo">demo (Ï€ÏÎ¿ÎµÏ€Î¹Î»Î¿Î³Î®)</option>
                <% } %>
              </select>
              <span class="hint">Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î¿Î½Ï„Î±Î¹ config / products / categories</span>
            </label>

            <label>
              ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ admin *
              <input type="text" name="adminPasswordPlain" required autocomplete="new-password"
                     placeholder="Î‘ÏÏ‡Î¹ÎºÏŒÏ‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Î³Î¹Î± Ï„Î¿Î½ Î¹Î´Î¹Î¿ÎºÏ„Î®Ï„Î·" />
              <span class="hint">Î˜Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„ÎµÎ¯ Ï‰Ï‚ bcrypt hash</span>
            </label>

            <label>
              Referral ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ (Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ)
              <input type="text" name="refCode" placeholder="Ï€.Ï‡. partner-giannis" />
              <span class="hint">Î‘Ï†Î®ÏƒÏ„Îµ ÎºÎµÎ½ÏŒ Î±Î½ Î´ÎµÎ½ Î±Î½Î®ÎºÎµÎ¹ ÏƒÎµ referral partner</span>
            </label>

            <label>
              Referral Ï€Î¿ÏƒÎ¿ÏƒÏ„ÏŒ %
              <input type="number" name="refPercent" value="10" min="1" max="50" step="1" />
              <span class="hint">Î Î¿ÏƒÎ¿ÏƒÏ„ÏŒ Ï€ÏÎ¿Î¼Î®Î¸ÎµÎ¹Î±Ï‚ (1â€“50%)</span>
            </label>

            <label class="full">
              Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ *
              <input type="password" name="rootPassword" required placeholder="THRONOS_ROOT_ADMIN_PASSWORD" />
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" type="submit">+ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± tenant</button>
          </div>
        </form>
      </div>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   UPDATE TENANT                                           %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· tenant</h2>
        <p class="helper">Î‘Î»Î»Î±Î³Î® domain, Ï€Î±ÎºÎ­Ï„Î¿Ï… Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚ Î® ÎºÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·Ï‚ ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·Ï‚.</p>

        <% if (tenants.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ tenants Î³Î¹Î± ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ·.</p>
        <% } else { %>
        <form method="POST" action="/root/tenants/update" id="update-form">
          <div class="form-grid">
            <label>
              Tenant
              <select name="tenantId" id="update-tenant-select" onchange="prefillUpdate(this)">
                <% tenants.forEach(function(t) { %>
                  <option value="<%= t.id %>"
                    data-domain="<%= t.domain || '' %>"
                    data-tier="<%= t.supportTier %>"
                    data-active="<%= t.active ? 'true' : 'false' %>">
                    <%= t.id %>
                  </option>
                <% }) %>
              </select>
            </label>

            <label>
              Domain
              <input type="text" name="domain" id="update-domain" placeholder="Ï€.Ï‡. myshop.gr" />
            </label>

            <label>
              Î Î±ÎºÎ­Ï„Î¿ Ï…Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·Ï‚
              <select name="supportTier" id="update-tier">
                <option value="SELF_SERVICE">SELF_SERVICE</option>
                <option value="MANAGEMENT_START">MANAGEMENT_START</option>
                <option value="FULL_OPS_START">FULL_OPS_START</option>
              </select>
            </label>

            <label>
              ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·
              <select name="active" id="update-active">
                <option value="true">Î•Î½ÎµÏÎ³ÏŒ</option>
                <option value="false">Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ</option>
              </select>
            </label>

            <label class="full">
              Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ *
              <input type="password" name="rootPassword" required placeholder="THRONOS_ROOT_ADMIN_PASSWORD" />
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-warning" type="submit">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ·</button>
          </div>
        </form>
        <% } %>
      </div>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   RESET ADMIN PASSWORD                                    %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï admin</h2>
        <p class="helper">ÎŸÏÎ¯ÏƒÏ„Îµ Î½Î­Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ Î³Î¹Î± Ï„Î¿Î½ admin ÎµÎ½ÏŒÏ‚ tenant. Î˜Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Ï„ÎµÎ¯ Ï‰Ï‚ bcrypt hash.</p>

        <% if (tenants.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ tenants.</p>
        <% } else { %>
        <form method="POST" action="/root/tenants/reset-admin-password">
          <div class="form-grid">
            <label>
              Tenant
              <select name="tenantId">
                <% tenants.forEach(function(t) { %>
                  <option value="<%= t.id %>"><%= t.id %></option>
                <% }) %>
              </select>
            </label>

            <label>
              ÎÎ­Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ admin *
              <input type="text" name="newPassword" required autocomplete="new-password"
                     placeholder="ÎÎ­Î¿Ï‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚" />
            </label>

            <label class="full">
              Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ *
              <input type="password" name="rootPassword" required placeholder="THRONOS_ROOT_ADMIN_PASSWORD" />
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-danger" type="submit">Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï</button>
          </div>
        </form>
        <% } %>
      </div>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   GATEWAY SURCHARGE (ROOT ONLY)                           %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Gateway Surcharge (Î±Î½Î¬ tenant)</h2>
        <p class="helper">
          ÎŸÏÎ¯ÏƒÏ„Îµ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÎ±ÏÎ¾Î·ÏƒÎ· gateway (%) Î±Î½Î¬ Ï„ÏÏŒÏ€Î¿ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î³Î¹Î± ÎºÎ¬Î¸Îµ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±.
          Î‘Ï…Ï„Î® Î· ÏÏÎ¸Î¼Î¹ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î¿ÏÎ±Ï„Î® Î¼ÏŒÎ½Î¿ ÏƒÏ„Î¿ Root Admin.
        </p>

        <% if (tenants.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ tenants.</p>
        <% } else { %>
        <form method="POST" action="/root/tenants/payment-config" id="surcharge-form">
          <div class="form-grid">
            <label>
              Tenant
              <select name="tenantId" id="surcharge-tenant-select" onchange="renderSurchargeFields(this.value)">
                <% tenants.forEach(function(t) { %>
                  <option value="<%= t.id %>"><%= t.id %></option>
                <% }) %>
              </select>
            </label>
          </div>

          <div id="surcharge-fields" style="margin:12px 0 16px;"></div>

          <div class="form-grid">
            <label class="full">
              Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ *
              <input type="password" name="rootPassword" required placeholder="THRONOS_ROOT_ADMIN_PASSWORD" />
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· surcharges</button>
          </div>
        </form>
        <% } %>
      </div>

      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   REFERRAL CONFIG (per tenant)                            %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Referral Config (Î±Î½Î¬ tenant)</h2>
        <p class="helper">Î£ÏÎ½Î´ÎµÏƒÎ· tenant Î¼Îµ referral partner ÎºÎ±Î¹ Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î¿ÏƒÎ¿ÏƒÏ„Î¿Ï Ï€ÏÎ¿Î¼Î®Î¸ÎµÎ¹Î±Ï‚.</p>

        <% if (tenants.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ tenants.</p>
        <% } else { %>
        <form method="POST" action="/root/tenants/referral">
          <div class="form-grid">
            <label>
              Tenant
              <select name="tenantId">
                <% tenants.forEach(function(t) { %>
                  <option value="<%= t.id %>">
                    <%= t.id %><%= (t.referral && t.referral.code) ? ' (' + t.referral.code + ')' : '' %>
                  </option>
                <% }) %>
              </select>
            </label>

            <label>
              Referral ÎºÏ‰Î´Î¹ÎºÏŒÏ‚
              <input type="text" name="refCode" placeholder="Ï€.Ï‡. partner-giannis" />
              <span class="hint">Î‘Ï†Î®ÏƒÏ„Îµ ÎºÎµÎ½ÏŒ Î³Î¹Î± ÎºÎ±Ï„Î¬ÏÎ³Î·ÏƒÎ· referral</span>
            </label>

            <label>
              Referral Ï€Î¿ÏƒÎ¿ÏƒÏ„ÏŒ %
              <input type="number" name="refPercent" value="10" min="1" max="50" step="1" />
            </label>

            <label class="full">
              Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ *
              <input type="password" name="rootPassword" required placeholder="THRONOS_ROOT_ADMIN_PASSWORD" />
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Referral Config</button>
          </div>
        </form>
        <% } %>
      </div>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   REFERRAL ACCOUNTS (payout settings)                     %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Referral Accounts (ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚)</h2>
        <p class="helper">ÎŸÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„ÏÏŒÏ€Î¿Ï… Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚ Î±Î½Î¬ referral account (crypto wallet Î® IBAN).</p>

        <% const refAccountKeys = Object.keys(refAccounts); %>
        <% if (refAccountKeys.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ referral accounts.</p>
        <% } else { %>
          <% refAccountKeys.forEach(function(code) { %>
            <% const acc = refAccounts[code]; %>
            <details style="margin-bottom:14px;border:1px solid #e5e7eb;border-radius:8px;padding:12px 16px;">
              <summary style="cursor:pointer;font-weight:600;">
                <code><%= code %></code>
                <span style="color:#6b7280;font-size:0.83rem;margin-left:8px;">
                  <%= (acc.percent * 100).toFixed(0) %>% &middot;
                  Tenants: <%= (acc.tenants || []).join(', ') || 'â€“' %>
                </span>
              </summary>
              <form method="POST" action="/root/referral/account" style="margin-top:14px;">
                <input type="hidden" name="refCode" value="<%= code %>" />
                <div class="form-grid">
                  <label>
                    Î¤ÏÏŒÏ€Î¿Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚
                    <select name="payoutMode">
                      <option value="crypto" <%= acc.payoutMode === 'crypto' ? 'selected' : '' %>>Crypto</option>
                      <option value="fiat"   <%= acc.payoutMode === 'fiat'   ? 'selected' : '' %>>Fiat (IBAN)</option>
                    </select>
                  </label>

                  <label>
                    Crypto Wallet
                    <input type="text" name="wallet" value="<%= acc.wallet || '' %>" placeholder="0xâ€¦" />
                  </label>

                  <label>
                    IBAN / Fiat Î»ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚
                    <input type="text" name="fiatMethod" value="<%= acc.fiatMethod || '' %>"
                           placeholder="IBAN GRâ€¦ Î® ÏƒÎ·Î¼ÎµÎ¯Ï‰ÏƒÎ·" />
                  </label>

                  <label class="full">
                    Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ *
                    <input type="password" name="rootPassword" required placeholder="THRONOS_ROOT_ADMIN_PASSWORD" />
                  </label>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
                </div>
              </form>
            </details>
          <% }) %>
        <% } %>
      </div>


      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <%#   REFERRAL PAYOUTS                                        %>
      <%# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• %>
      <div class="card">
        <h2>Referral Payouts</h2>
        <p class="helper">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Ï€ÏÎ¿Î¼Î®Î¸ÎµÎ¹ÎµÏ‚ Î±Î½Î¬ referral partner. Î£Î·Î¼ÎµÎ¹ÏÏƒÏ„Îµ Ï‰Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚ Î¼ÎµÏ„Î¬ Ï„Î·Î½ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·.</p>

        <% const pendingCodes = Object.keys(pendingByCode); %>
        <% if (pendingCodes.length === 0) { %>
          <p style="color:#888;font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚. ğŸ‰</p>
        <% } else { %>
          <% pendingCodes.forEach(function(code) { %>
            <% const grp = pendingByCode[code]; %>
            <div style="border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:18px;">
              <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
                <div>
                  <strong style="font-size:1.05rem;"><code><%= code %></code></strong>
                  <% const acc2 = refAccounts[code]; %>
                  <% if (acc2) { %>
                    <span style="color:#6b7280;font-size:0.82rem;margin-left:8px;">
                      <%= acc2.payoutMode === 'crypto' ? 'ğŸ”— ' + (acc2.wallet || 'â€”') : 'ğŸ¦ ' + (acc2.fiatMethod || 'â€”') %>
                    </span>
                  <% } %>
                </div>
                <span style="font-size:1.1rem;font-weight:700;color:#059669;">
                  Î£ÏÎ½Î¿Î»Î¿: <%= grp.total.toFixed(2) %> â‚¬
                </span>
              </div>

              <table style="width:100%;border-collapse:collapse;font-size:0.83rem;margin-bottom:14px;">
                <thead>
                  <tr style="background:#f0f2fa;">
                    <th style="padding:5px 8px;text-align:left;">Tenant</th>
                    <th style="padding:5px 8px;text-align:left;">Event</th>
                    <th style="padding:5px 8px;text-align:right;">Î Î¿ÏƒÏŒ â‚¬</th>
                    <th style="padding:5px 8px;text-align:left;">Î—Î¼/Î½Î¯Î±</th>
                    <th style="padding:5px 8px;text-align:center;">Î•Î½Î­ÏÎ³ÎµÎ¹Î±</th>
                  </tr>
                </thead>
                <tbody>
                  <% grp.rows.forEach(function(row) { %>
                    <tr style="border-bottom:1px solid #f3f4f6;">
                      <td style="padding:5px 8px;"><code><%= row.tenantId %></code></td>
                      <td style="padding:5px 8px;color:#6b7280;"><%= row.eventType || 'â€“' %></td>
                      <td style="padding:5px 8px;text-align:right;font-weight:600;"><%= row.amountFiat.toFixed(2) %></td>
                      <td style="padding:5px 8px;color:#6b7280;"><%= new Date(row.createdAt).toLocaleDateString('el') %></td>
                      <td style="padding:5px 8px;text-align:center;">
                        <form method="POST" action="/root/referral/mark-paid" style="display:inline;">
                          <input type="hidden" name="earningId" value="<%= row.id %>" />
                          <input type="hidden" name="refCode"   value="<%= code %>" />
                          <input type="text"   name="paidVia"   placeholder="crypto/IBAN" style="width:80px;padding:3px 5px;border:1px solid #d1d5db;border-radius:3px;font-size:0.8rem;" />
                          <input type="text"   name="txId"      placeholder="tx/ref" style="width:80px;padding:3px 5px;border:1px solid #d1d5db;border-radius:3px;font-size:0.8rem;" />
                          <input type="hidden" name="rootPassword" class="root-pw-payouts" value="" />
                          <button class="btn btn-sm" type="submit" style="font-size:0.78rem;padding:3px 8px;">âœ“ Î Î»Î®ÏÏ‰ÏƒÎ±</button>
                        </form>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>

              <%# Mark ALL pending for this code as paid %>
              <form method="POST" action="/root/referral/mark-paid" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                <input type="hidden" name="refCode" value="<%= code %>" />
                <strong style="font-size:0.88rem;">Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎµ ÎŸÎ›Î‘ Ï‰Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î±:</strong>
                <input type="text" name="paidVia" placeholder="crypto/IBAN" style="padding:5px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.85rem;width:120px;" />
                <input type="text" name="txId"    placeholder="tx/ref #" style="padding:5px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.85rem;width:120px;" />
                <input type="password" name="rootPassword" required placeholder="Root ÎºÏ‰Î´Î¹ÎºÏŒÏ‚" style="padding:5px 8px;border:1px solid #d1d5db;border-radius:4px;font-size:0.85rem;width:140px;" />
                <button class="btn btn-warning" type="submit">âœ“ Mark All Paid (<%= grp.total.toFixed(2) %> â‚¬)</button>
              </form>
            </div>
          <% }) %>
        <% } %>

        <%# Paid history (last 20) %>
        <% const paidRows = refEarnings.filter(function(e) { return e.status === 'paid'; }).slice(-20).reverse(); %>
        <% if (paidRows.length > 0) { %>
          <details style="margin-top:20px;">
            <summary style="cursor:pointer;color:#6b7280;font-size:0.88rem;">Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Ï€Î»Î·ÏÏ‰Î¼ÏÎ½ (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± <%= paidRows.length %>)</summary>
            <table style="width:100%;border-collapse:collapse;font-size:0.82rem;margin-top:10px;">
              <thead>
                <tr style="background:#f0f2fa;">
                  <th style="padding:5px 8px;text-align:left;">Code</th>
                  <th style="padding:5px 8px;text-align:left;">Tenant</th>
                  <th style="padding:5px 8px;text-align:right;">Î Î¿ÏƒÏŒ â‚¬</th>
                  <th style="padding:5px 8px;text-align:left;">Via</th>
                  <th style="padding:5px 8px;text-align:left;">Tx/Ref</th>
                  <th style="padding:5px 8px;text-align:left;">Î—Î¼/Î½Î¯Î±</th>
                </tr>
              </thead>
              <tbody>
                <% paidRows.forEach(function(row) { %>
                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:5px 8px;"><code><%= row.refCode %></code></td>
                    <td style="padding:5px 8px;"><code><%= row.tenantId %></code></td>
                    <td style="padding:5px 8px;text-align:right;"><%= row.amountFiat.toFixed(2) %></td>
                    <td style="padding:5px 8px;color:#6b7280;"><%= row.paidVia || 'â€“' %></td>
                    <td style="padding:5px 8px;color:#6b7280;font-size:0.78rem;"><%= row.txId || 'â€“' %></td>
                    <td style="padding:5px 8px;color:#6b7280;"><%= row.paidAt ? new Date(row.paidAt).toLocaleDateString('el') : 'â€“' %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </details>
        <% } %>
      </div>


      <div class="root-pass-note">
        <strong>Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ· Î±ÏƒÏ†Î±Î»ÎµÎ¯Î±Ï‚:</strong> Î¤Î¿ root password Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ Î¼Î­ÏƒÏ‰ Ï„Î·Ï‚ env Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î®Ï‚
        <code>THRONOS_ROOT_ADMIN_PASSWORD</code>. Î§Ï‰ÏÎ¯Ï‚ Î±Ï…Ï„Î®, ÎºÎ±Î½Î­Î½Î± root action Î´ÎµÎ½ ÎµÎºÏ„ÎµÎ»ÎµÎ¯Ï„Î±Î¹.
        ÎœÎ·Î½ Î¼Î¿Î¹ÏÎ±ÏƒÏ„ÎµÎ¯Ï„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ URL Î® Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ.
      </div>

    </div><%# /root-layout %>

    <script>
      // â”€â”€ Gateway Surcharge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const tenantPaymentConfigs = <%- JSON.stringify(tenantPaymentConfigs) %>;

      function renderSurchargeFields(tenantId) {
        const container = document.getElementById('surcharge-fields');
        const opts = tenantPaymentConfigs[tenantId] || [];
        if (opts.length === 0) {
          container.innerHTML = '<p style="color:#aaa;font-style:italic;font-size:0.85rem;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ payment options Î³Î¹Î± Î±Ï…Ï„ÏŒ Ï„Î¿ tenant.</p>';
          return;
        }
        let html = '<table style="border-collapse:collapse;font-size:0.86rem;width:100%;">' +
          '<thead><tr><th style="text-align:left;padding:6px 10px;background:#f0f2fa;">ID</th>' +
          '<th style="text-align:left;padding:6px 10px;background:#f0f2fa;">Label</th>' +
          '<th style="text-align:left;padding:6px 10px;background:#f0f2fa;">Surcharge %</th></tr></thead><tbody>';
        opts.forEach(function(opt, i) {
          html += '<tr><td style="padding:6px 10px;"><code>' + opt.id + '</code></td>' +
            '<td style="padding:6px 10px;">' + (opt.label || 'â€“') + '</td>' +
            '<td style="padding:6px 10px;"><input type="number" name="surcharge_' + i + '" ' +
            'value="' + (opt.gatewaySurchargePercent || 0) + '" min="0" step="0.001" ' +
            'style="width:90px;padding:5px 8px;border:1px solid #d1d5db;border-radius:4px;" /></td></tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      }

      // Render on page load
      const surchargeSelect = document.getElementById('surcharge-tenant-select');
      if (surchargeSelect) renderSurchargeFields(surchargeSelect.value);

      // â”€â”€ Update form pre-fill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const tenantData = {
        <% tenants.forEach(function(t, i) { %>
          "<%= t.id %>": {
            domain: "<%- (t.domain || '').replace(/"/g, '\\"') %>",
            tier: "<%= t.supportTier %>",
            active: <%= t.active ? 'true' : 'false' %>
          }<%= i < tenants.length - 1 ? ',' : '' %>
        <% }) %>
      };

      function prefillUpdate(select) {
        const d = tenantData[select.value];
        if (!d) return;
        document.getElementById('update-domain').value = d.domain;
        const tierSel = document.getElementById('update-tier');
        for (let i = 0; i < tierSel.options.length; i++) {
          if (tierSel.options[i].value === d.tier) { tierSel.selectedIndex = i; break; }
        }
        const activeSel = document.getElementById('update-active');
        for (let i = 0; i < activeSel.options.length; i++) {
          if ((activeSel.options[i].value === 'true') === d.active) { activeSel.selectedIndex = i; break; }
        }
      }

      // Pre-fill on page load
      const sel = document.getElementById('update-tenant-select');
      if (sel) prefillUpdate(sel);

      // â”€â”€ Referral payouts: sync root password to inline per-row forms â”€â”€
      // Each per-row form has a hidden input.root-pw-payouts; user types
      // the root password in the "Mark All" form and we mirror it upward.
      document.querySelectorAll('form[action="/root/referral/mark-paid"]').forEach(function(form) {
        const pwInput = form.querySelector('input[name="rootPassword"]');
        if (!pwInput) return;
        pwInput.addEventListener('input', function() {
          // If this is the "mark all" form (visible password field), mirror to sibling inline forms
          const card = form.closest('div');
          if (!card) return;
          card.querySelectorAll('input.root-pw-payouts').forEach(function(hidden) {
            hidden.value = pwInput.value;
          });
        });
      });
    </script>
  </body>
</html>
