<!DOCTYPE html>
<html lang="el">
  <head>
    <meta charset="UTF-8" />
    <title>Διαχείριση – <%= config.storeName %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <style>
      :root {
        --primary-color: <%= config.primaryColor %>;
        --accent-color: <%= config.accentColor %>;
        --font-family: <%= config.fontFamily %>;
        --menu-bg: <%= (config.theme && config.theme.menuBg) || '#111' %>;
        --menu-text: <%= (config.theme && config.theme.menuText) || '#fff' %>;
        --menu-active-bg: <%= (config.theme && config.theme.menuActiveBg) || '#f06292' %>;
        --menu-active-text: <%= (config.theme && config.theme.menuActiveText) || '#fff' %>;
        --button-radius: <%= (config.theme && config.theme.buttonRadius) || '4px' %>;
      }

      /* ── Full-Ops banner ── */
      .fullops-banner {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        padding: 14px 18px;
        margin-bottom: 20px;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #5a4200;
      }

      /* ── Products table & modal ── */
      .products-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
      .products-table th, .products-table td {
        text-align: left; padding: 8px 10px;
        border-bottom: 1px solid #e0e0e0; font-size: 0.88rem;
      }
      .products-table th { background: #f5f5f5; font-weight: 600; }
      .products-table .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; }
      .products-table .no-img { width: 48px; height: 48px; background: #eee; border-radius: 4px; display: inline-block; }
      .btn-sm { padding: 4px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
                border: 1px solid #ccc; background: #fff; }
      .btn-sm.edit { border-color: var(--accent-color); color: var(--accent-color); }
      .btn-sm.del  { border-color: #e57373; color: #e57373; }
      .btn-sm:disabled { opacity: 0.4; cursor: not-allowed; }

      /* modal overlay */
      .modal-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(0,0,0,.45); z-index: 900;
        align-items: center; justify-content: center;
      }
      .modal-overlay.open { display: flex; }
      .modal-box {
        background: #fff; border-radius: 8px; padding: 28px 28px 20px;
        width: min(520px, 95vw); max-height: 90vh; overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,.18);
      }
      .modal-box h3 { margin-top: 0; }
      .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .modal-grid .full { grid-column: 1 / -1; }
      .modal-grid label { display: flex; flex-direction: column; gap: 4px; font-size: 0.86rem; }
      .modal-grid input, .modal-grid textarea, .modal-grid select {
        padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;
      }
      .modal-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }

      /* helper text */
      .helper { font-size: 0.82rem; color: #666; margin: 0 0 12px; }

      /* password row for product save */
      .save-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
      .save-row input[type=password] { flex: 1 1 180px; }

      /* ── Shipping & Payment table ── */
      .sp-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
      .sp-table th, .sp-table td {
        padding: 8px 10px; text-align: left;
        border-bottom: 1px solid #e0e0e0; font-size: 0.87rem;
      }
      .sp-table th { background: #f5f5f5; font-weight: 600; white-space: nowrap; }
      .sp-table input[type=text],
      .sp-table input[type=number] {
        width: 100%; box-sizing: border-box;
        padding: 5px 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.87rem;
      }
      .sp-table input:read-only { background: #f9f9f9; color: #888; cursor: not-allowed; }
      .sp-badge {
        display: inline-block; background: #e8f4fd; color: #1a73b8;
        border-radius: 3px; padding: 1px 6px; font-size: 0.76rem; font-family: monospace;
      }

      /* ── Color picker pairs ── */
      .color-field { display: flex; gap: 6px; align-items: center; }
      .color-field input[type=text]  { flex: 1; }
      .color-field input[type=color] {
        width: 36px; height: 34px; padding: 2px;
        border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: #fff;
        flex-shrink: 0;
      }
      .color-field input[type=color]:disabled { opacity: 0.4; cursor: not-allowed; }

      /* ── Logo upload inline ── */
      .logo-upload-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 4px; }
      .logo-upload-row input[type=file] { flex: 1 1 160px; font-size: 0.82rem; }
      .btn-xs { padding: 5px 12px; font-size: 0.8rem; background: #eee;
                border: 1px solid #ccc; border-radius: 4px; cursor: pointer; white-space: nowrap; }
      #logo-upload-status { font-size: 0.8rem; color: #555; margin-top: 4px; }

      /* ── Notifications section ── */
      .notif-section { margin-top: 22px; padding-top: 16px; border-top: 1px dashed #ddd; }
      .notif-section h3 { margin: 0 0 4px; }
      .checkbox-label { display: flex !important; flex-direction: row !important;
                        align-items: center; gap: 8px; cursor: pointer; }
      .checkbox-label input[type=checkbox] { width: auto; margin: 0; }
    </style>
  </head>
  <body>
    <header>
      <h1>Thronos Commerce · Διαχείριση</h1>
      <p class="subtitle">
        Κατάστημα: <strong><%= tenant.id %></strong>
        &nbsp;·&nbsp;
        Πακέτο: <strong><%= tenant.supportTier %></strong>
        &nbsp;·&nbsp;
        <a href="/admin" style="font-size:0.85rem">Ρυθμίσεις</a>
        &nbsp;|&nbsp;
        <a href="/admin/orders" style="font-size:0.85rem">Παραγγελίες</a>
        &nbsp;|&nbsp;
        <a href="/" style="font-size:0.85rem">Κατάστημα ↗</a>
      </p>
    </header>

    <main class="admin-layout">

      <%# ── Full-Ops banner ── %>
      <% if (tenant.supportTier === 'FULL_OPS_START') { %>
      <div class="fullops-banner">
        <strong>Πρόγραμμα Full Ops ενεργό.</strong><br>
        Το κατάστημά σας βρίσκεται σε πρόγραμμα Full Ops – η ομάδα Thronos Commerce
        αναλαμβάνει όλες τις αλλαγές. Επικοινωνήστε μαζί μας για ενημερώσεις.
      </div>
      <% } %>

      <%# ── Flash messages ── %>
      <% if (message) { %><p class="admin-msg success"><%= message %></p><% } %>
      <% if (error)   { %><p class="admin-msg error"><%= error %></p><% } %>

      <nav class="admin-tabs">
        <a href="#tab-theme">Εμφάνιση &amp; Ρυθμίσεις</a>
        <a href="#tab-categories">Κατηγορίες</a>
        <a href="#tab-products">Προϊόντα</a>
        <a href="#tab-upload">Εικόνες</a>
        <a href="#tab-shipping">Μεταφορικά &amp; Πληρωμή</a>
        <a href="/admin/orders">Παραγγελίες</a>
      </nav>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 1 – THEME / SETTINGS                                %>
      <%# ══════════════════════════════════════════════════════════ %>
      <form id="tab-theme" class="admin-block" method="POST" action="/admin/settings">
        <h2>Εμφάνιση &amp; Ρυθμίσεις καταστήματος</h2>
        <p class="helper">Αλλάξτε το όνομα, τα χρώματα και τα βασικά στοιχεία του καταστήματός σας.</p>

        <label><span>Όνομα καταστήματος</span>
          <input type="text" name="storeName" value="<%= config.storeName %>"
                 <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>

        <label><span>Κύριο χρώμα</span>
          <div class="color-field">
            <input type="text" name="primaryColor" id="txt-primaryColor"
                   value="<%= config.primaryColor %>" placeholder="#222222"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-primaryColor" value="<%= config.primaryColor || '#222222' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span>Χρώμα έμφασης</span>
          <div class="color-field">
            <input type="text" name="accentColor" id="txt-accentColor"
                   value="<%= config.accentColor %>" placeholder="#00ff88"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-accentColor" value="<%= config.accentColor || '#00ff88' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span>Γραμματοσειρά</span>
          <select name="fontFamily" <%= permissions.canEditSettings ? '' : 'disabled' %>>
            <option value="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
              <%= config.fontFamily.includes('system-ui') ? 'selected' : '' %>>System UI (προεπιλογή)</option>
            <option value="'Roboto', Arial, sans-serif"
              <%= config.fontFamily.includes('Roboto') ? 'selected' : '' %>>Roboto</option>
            <option value="'Segoe UI', system-ui, sans-serif"
              <%= config.fontFamily.includes('Segoe UI') && !config.fontFamily.includes('system-ui, -apple') ? 'selected' : '' %>>Segoe UI</option>
          </select>
        </label>

        <label><span>Κείμενο banner αρχικής σελίδας</span>
          <textarea name="heroText" rows="3"
                    <%= permissions.canEditSettings ? '' : 'readonly' %>><%= config.heroText %></textarea>
        </label>

        <label><span>Web3 domain (προαιρετικό)</span>
          <input type="text" name="web3Domain" value="<%= config.web3Domain %>"
                 placeholder="π.χ. mystore.thr" <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>

        <label><span>Διαδρομή λογότυπου</span>
          <input type="text" name="logoPath" id="logoPath-input" value="<%= config.logoPath %>"
                 placeholder="/logo.svg" <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>
        <% if (permissions.canUploadMedia) { %>
        <div style="margin:-4px 0 14px;">
          <p class="helper" style="margin-bottom:5px;">Ή ανεβάστε νέο αρχείο logo απευθείας:</p>
          <div class="logo-upload-row">
            <input type="file" id="logo-file" accept="image/*" />
            <input type="password" id="logo-pass" placeholder="Κωδικός" style="width:130px;" />
            <button type="button" class="btn-xs" id="logo-upload-btn">Ανέβασμα logo</button>
          </div>
          <p id="logo-upload-status"></p>
        </div>
        <% } %>

        <h3>Χρώματα μενού &amp; κουμπιών</h3>
        <p class="helper">Προσαρμόστε την παλέτα του πλαϊνού μενού και τις γωνίες κουμπιών.</p>

        <label><span>Φόντο μενού</span>
          <div class="color-field">
            <input type="text" name="themeMenuBg" id="txt-themeMenuBg"
                   value="<%= (config.theme && config.theme.menuBg) || '#111111' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuBg"
                   value="<%= (config.theme && config.theme.menuBg) || '#111111' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span>Κείμενο μενού</span>
          <div class="color-field">
            <input type="text" name="themeMenuText" id="txt-themeMenuText"
                   value="<%= (config.theme && config.theme.menuText) || '#ffffff' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuText"
                   value="<%= (config.theme && config.theme.menuText) || '#ffffff' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span>Φόντο ενεργού στοιχείου μενού</span>
          <div class="color-field">
            <input type="text" name="themeMenuActiveBg" id="txt-themeMenuActiveBg"
                   value="<%= (config.theme && config.theme.menuActiveBg) || '#f06292' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuActiveBg"
                   value="<%= (config.theme && config.theme.menuActiveBg) || '#f06292' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span>Κείμενο ενεργού στοιχείου μενού</span>
          <div class="color-field">
            <input type="text" name="themeMenuActiveText" id="txt-themeMenuActiveText"
                   value="<%= (config.theme && config.theme.menuActiveText) || '#ffffff' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuActiveText"
                   value="<%= (config.theme && config.theme.menuActiveText) || '#ffffff' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span>Ακτίνα γωνιών κουμπιών</span>
          <input type="text" name="themeButtonRadius"
                 value="<%= (config.theme && config.theme.buttonRadius) || '4px' %>"
                 placeholder="4px" <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>

        <%# ── Ειδοποιήσεις ── %>
        <div class="notif-section">
          <h3>Ειδοποιήσεις παραγγελιών – Email</h3>
          <p class="helper">
            Κάθε νέα παραγγελία θα στέλνει αυτόματα email στις παρακάτω διευθύνσεις.
            Απαιτείται ρύθμιση SMTP στο περιβάλλον (THRC_SMTP_HOST / THRC_SMTP_USER / THRC_SMTP_PASS).
          </p>

          <label><span>Email ειδοποιήσεων <small style="color:#999">(ένα ανά γραμμή)</small></span>
            <textarea name="notificationEmails" rows="3"
                      placeholder="owner@myshop.gr&#10;backup@myshop.gr"
                      <%= permissions.canEditSettings ? '' : 'readonly' %>><%= (config.notificationEmails || []).join('\n') %></textarea>
          </label>

          <label class="checkbox-label">
            <input type="checkbox" name="notificationCcCustomer"
                   <%= (config.notificationCcCustomer) ? 'checked' : '' %>
                   <%= permissions.canEditSettings ? '' : 'disabled' %> />
            <span>Αποστολή αντιγράφου email και στον πελάτη (CC)</span>
          </label>

          <label><span>Εμφανιζόμενο όνομα αποστολέα</span>
            <input type="text" name="notificationFromName"
                   value="<%= config.notificationFromName || '' %>"
                   placeholder="π.χ. FashionMM Store"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
          </label>

          <h3 style="margin-top:18px;">Ειδοποιήσεις παραγγελιών – Webhook</h3>
          <p class="helper">
            Για mobile / Viber ειδοποιήσεις: βάλτε το URL του δικού σας webhook service.
            Κάθε νέα παραγγελία θα κάνει POST εκεί αυτόματα.
          </p>

          <label><span>Webhook URL <small style="color:#999">(προαιρετικό)</small></span>
            <input type="text" name="notificationWebhookUrl"
                   value="<%= config.notificationWebhookUrl || '' %>"
                   placeholder="https://myhook.example.com/orders"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
          </label>

          <label><span>Webhook Secret <small style="color:#999">(για υπογραφή X-Thronos-Signature)</small></span>
            <input type="text" name="notificationWebhookSecret"
                   value="<%= config.notificationWebhookSecret || '' %>"
                   placeholder="mysecret123"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
          </label>
        </div>

        <label><span>Κωδικός διαχειριστή</span>
          <input type="password" name="password"
                 <%= permissions.canEditSettings ? 'required' : 'disabled' %> />
        </label>

        <button type="submit" class="button" <%= permissions.canEditSettings ? '' : 'disabled' %>>
          Αποθήκευση ρυθμίσεων
        </button>
        <% if (!permissions.canEditSettings) { %>
          <p class="helper" style="margin-top:8px;">
            Οι ρυθμίσεις διαχειρίζονται από την ομάδα Thronos Commerce στο πλαίσιο του πακέτου σας.
          </p>
        <% } %>
      </form>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 2 – CATEGORIES                                      %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-categories" class="admin-block">
        <h2>Κατηγορίες προϊόντων</h2>
        <p class="helper">Οργανώστε τα προϊόντα σας σε κατηγορίες ώστε οι πελάτες να βρίσκουν εύκολα αυτό που ψάχνουν.</p>

        <table class="admin-table">
          <thead>
            <tr>
              <th>Κωδικός</th>
              <th>Όνομα</th>
              <th>Slug (URL)</th>
              <th>Ενέργεια</th>
            </tr>
          </thead>
          <tbody>
            <% categories.forEach(function(cat){ %>
              <tr>
                <td><code><%= cat.id %></code></td>
                <td><%= cat.name %></td>
                <td><%= cat.slug %></td>
                <td>
                  <form method="POST" action="/admin/categories/delete" class="inline-form">
                    <input type="hidden" name="categoryId" value="<%= cat.id %>" />
                    <input type="password" name="password" placeholder="Κωδικός"
                           <%= permissions.canEditCategories ? 'required' : 'disabled' %> />
                    <button type="submit" class="button danger"
                            <%= permissions.canEditCategories ? '' : 'disabled' %>>Διαγραφή</button>
                  </form>
                </td>
              </tr>
            <% }) %>
            <% if (categories.length === 0) { %>
              <tr><td colspan="4" style="color:#888;font-style:italic;">Δεν υπάρχουν κατηγορίες ακόμα.</td></tr>
            <% } %>
          </tbody>
        </table>

        <% if (permissions.canEditCategories) { %>
        <form method="POST" action="/admin/categories/add" class="admin-subform">
          <h3>Νέα κατηγορία</h3>
          <p class="helper">Συμπληρώστε τον μοναδικό κωδικό (π.χ. "bags"), το εμφανιζόμενο όνομα και το slug για το URL.</p>
          <input type="text" name="id" placeholder="Κωδικός (π.χ. bags)" required />
          <input type="text" name="name" placeholder="Όνομα (π.χ. Τσάντες)" required />
          <input type="text" name="slug" placeholder="Slug (π.χ. tsantes)" required />
          <input type="password" name="password" placeholder="Κωδικός διαχειριστή" required />
          <button type="submit" class="button">Προσθήκη κατηγορίας</button>
        </form>

        <form method="POST" action="/admin/categories/update" class="admin-subform">
          <h3>Μετονομασία κατηγορίας</h3>
          <select name="categoryId">
            <% categories.forEach(function(cat){ %>
              <option value="<%= cat.id %>"><%= cat.name %> (<%= cat.id %>)</option>
            <% }) %>
          </select>
          <input type="text" name="name" placeholder="Νέο όνομα" required />
          <input type="text" name="slug" placeholder="Νέο slug" required />
          <input type="password" name="password" placeholder="Κωδικός διαχειριστή" required />
          <button type="submit" class="button">Ενημέρωση</button>
        </form>
        <% } else { %>
          <p class="helper">Η διαχείριση κατηγοριών γίνεται από την ομάδα Thronos Commerce στο πλαίσιο του πακέτου σας.</p>
        <% } %>
      </section>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 3 – PRODUCTS (table + modal editor)                 %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-products" class="admin-block">
        <h2>Προϊόντα καταστήματος</h2>
        <p class="helper">
          Διαχειριστείτε τα προϊόντα του καταστήματός σας. Κάντε κλικ «Επεξεργασία» για να αλλάξετε ένα προϊόν ή «Νέο προϊόν» για να προσθέσετε νέο.
          Όταν είστε έτοιμοι, πατήστε <strong>Αποθήκευση όλων</strong>.
          <% if (!permissions.canEditProducts) { %>
            <br><em>Τα προϊόντα σας διαχειρίζεται η ομάδα Thronos Commerce.</em>
          <% } %>
        </p>

        <% if (permissions.canEditProducts) { %>
          <button class="button" id="btn-add-product" type="button">+ Νέο προϊόν</button>
        <% } %>

        <table class="products-table" id="products-table">
          <thead>
            <tr>
              <th></th>
              <th>Όνομα</th>
              <th>Τιμή (€)</th>
              <th>SKU</th>
              <th>Κατηγορία</th>
              <% if (permissions.canEditProducts) { %><th>Ενέργειες</th><% } %>
            </tr>
          </thead>
          <tbody id="products-tbody">
            <%# Rendered by JS below %>
          </tbody>
        </table>

        <%# Hidden form that submits the serialized JSON array to the backend %>
        <form id="products-save-form" method="POST" action="/admin/products">
          <input type="hidden" name="productsJson" id="products-json-input" />
          <% if (permissions.canEditProducts) { %>
          <div class="save-row">
            <label style="flex:1 1 auto;font-size:0.86rem;">
              Κωδικός διαχειριστή για αποθήκευση:
            </label>
            <input type="password" name="password" required placeholder="Κωδικός" />
            <button type="submit" class="button">Αποθήκευση όλων</button>
          </div>
          <% } %>
        </form>
      </section>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 4 – IMAGE UPLOAD                                    %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-upload" class="admin-block">
        <h2>Ανέβασμα εικόνας</h2>
        <p class="helper">Ανεβάστε μια εικόνα στον server και αντιγράψτε το URL της για να το χρησιμοποιήσετε στα προϊόντα σας.</p>
        <form id="upload-form" enctype="multipart/form-data">
          <input type="file" name="image" accept="image/*"
                 <%= permissions.canUploadMedia ? '' : 'disabled' %> required />
          <input type="password" name="password" placeholder="Κωδικός διαχειριστή"
                 <%= permissions.canUploadMedia ? 'required' : 'disabled' %> />
          <button class="button" type="submit"
                  <%= permissions.canUploadMedia ? '' : 'disabled' %>>Ανέβασμα</button>
        </form>
        <p id="upload-result"></p>
        <% if (!permissions.canUploadMedia) { %>
          <p class="helper">Το ανέβασμα εικόνων διαχειρίζεται η ομάδα Thronos Commerce.</p>
        <% } %>
      </section>

      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 5 – SHIPPING & PAYMENT                              %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-shipping" class="admin-block">
        <h2>Μεταφορικά &amp; Τρόποι Πληρωμής</h2>
        <p class="helper">
          Ορίστε τα κόστη αποστολής και τις χρεώσεις για κάθε τρόπο πληρωμής.
          Οι κωδικοί (id), οι επιτρεπόμενοι συνδυασμοί και ο τύπος πληρωμής <strong>δεν αλλάζουν</strong> εδώ —
          επικοινωνήστε με την ομάδα Thronos για δομικές αλλαγές.
        </p>

        <% if (!permissions.canEditSettings) { %>
          <p class="helper">
            Τα μεταφορικά διαχειρίζονται από την ομάδα Thronos Commerce στο πλαίσιο του πακέτου σας.
          </p>
        <% } %>

        <form method="POST" action="/admin/shipping-payment">

          <%# ── Shipping options ── %>
          <h3>Τρόποι αποστολής</h3>
          <% if ((config.shippingOptions || []).length === 0) { %>
            <p class="helper" style="color:#888;">Δεν υπάρχουν τρόποι αποστολής στη διαμόρφωση.</p>
          <% } else { %>
          <table class="sp-table">
            <thead>
              <tr>
                <th>Κωδικός (id)</th>
                <th>Ετικέτα</th>
                <th>Κόστος αποστολής (€)</th>
                <th>Προσαύξηση αντικαταβολής (€)</th>
                <th>Επιτρεπόμενες πληρωμές</th>
              </tr>
            </thead>
            <tbody>
              <% (config.shippingOptions || []).forEach(function(opt, i) { %>
              <tr>
                <td><span class="sp-badge"><%= opt.id %></span></td>
                <td>
                  <input type="text" name="ship_label_<%= i %>"
                         value="<%= opt.label || '' %>"
                         <%= permissions.canEditSettings ? 'required' : 'readonly' %> />
                </td>
                <td>
                  <input type="number" name="ship_base_<%= i %>"
                         value="<%= opt.base !== undefined ? opt.base : 0 %>"
                         min="0" step="0.01"
                         <%= permissions.canEditSettings ? '' : 'readonly' %> />
                </td>
                <td>
                  <input type="number" name="ship_codFee_<%= i %>"
                         value="<%= opt.codFee !== undefined ? opt.codFee : 0 %>"
                         min="0" step="0.01"
                         <%= permissions.canEditSettings ? '' : 'readonly' %> />
                </td>
                <td>
                  <% (opt.allowedPaymentMethods || []).forEach(function(pm) { %>
                    <span class="sp-badge"><%= pm %></span>
                  <% }) %>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
          <% } %>
          <p class="helper" style="margin-top:6px;">
            <strong>Κόστος βάσης:</strong> τα μεταφορικά σε €.&nbsp;
            <strong>COD προσαύξηση:</strong> προστίθεται μόνο όταν η πληρωμή είναι αντικαταβολή (COD).
          </p>

          <%# ── Payment options ── %>
          <h3>Τρόποι πληρωμής</h3>
          <% if ((config.paymentOptions || []).length === 0) { %>
            <p class="helper" style="color:#888;">Δεν υπάρχουν τρόποι πληρωμής στη διαμόρφωση.</p>
          <% } else { %>
          <table class="sp-table">
            <thead>
              <tr>
                <th>Κωδικός (id)</th>
                <th>Ετικέτα</th>
                <th>Τύπος</th>
                <th>Προσαύξηση gateway (%)</th>
              </tr>
            </thead>
            <tbody>
              <% (config.paymentOptions || []).forEach(function(opt, i) { %>
              <tr>
                <td><span class="sp-badge"><%= opt.id %></span></td>
                <td>
                  <input type="text" name="pay_label_<%= i %>"
                         value="<%= opt.label || '' %>"
                         <%= permissions.canEditSettings ? 'required' : 'readonly' %> />
                </td>
                <td><span class="sp-badge"><%= opt.type || '–' %></span></td>
                <td>
                  <input type="number" name="pay_surcharge_<%= i %>"
                         value="<%= opt.gatewaySurchargePercent !== undefined ? opt.gatewaySurchargePercent : 0 %>"
                         min="0" step="0.001"
                         <%= permissions.canEditSettings ? '' : 'readonly' %> />
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
          <% } %>
          <p class="helper" style="margin-top:6px;">
            <strong>Gateway surcharge %:</strong> προμήθεια platform πληρωμής π.χ. για Stripe. Μπορεί να είναι 0.
          </p>

          <% if (permissions.canEditSettings) { %>
          <div class="save-row">
            <label style="flex:1 1 auto;font-size:0.86rem;">Κωδικός διαχειριστή:</label>
            <input type="password" name="password" required placeholder="Κωδικός" />
            <button type="submit" class="button">Αποθήκευση</button>
          </div>
          <% } %>

        </form>
      </section>

    </main>


    <%# ══════════════════════════════════════════════════════════ %>
    <%#   PRODUCT MODAL                                           %>
    <%# ══════════════════════════════════════════════════════════ %>
    <div class="modal-overlay" id="product-modal">
      <div class="modal-box">
        <h3 id="modal-title">Προϊόν</h3>
        <div class="modal-grid">
          <label class="full"><span>Όνομα προϊόντος *</span>
            <input type="text" id="f-name" placeholder="π.χ. Δερμάτινη τσάντα" />
          </label>
          <label><span>Κωδικός (id) *</span>
            <input type="text" id="f-id" placeholder="π.χ. bag-001" />
          </label>
          <label><span>SKU</span>
            <input type="text" id="f-sku" placeholder="π.χ. SKU-123" />
          </label>
          <label><span>Τιμή (€) *</span>
            <input type="number" id="f-price" min="0" step="0.01" placeholder="0.00" />
          </label>
          <label><span>Απόθεμα</span>
            <input type="number" id="f-stock" min="0" step="1" placeholder="0" />
          </label>
          <label class="full"><span>Κατηγορία (categoryId)</span>
            <select id="f-category">
              <option value="">– Χωρίς κατηγορία –</option>
              <% categories.forEach(function(cat){ %>
                <option value="<%= cat.id %>"><%= cat.name %></option>
              <% }) %>
            </select>
          </label>
          <label class="full"><span>URL εικόνας</span>
            <input type="text" id="f-imageUrl" placeholder="/tenants/.../media/photo.jpg" />
          </label>
          <label class="full"><span>Περιγραφή</span>
            <textarea id="f-description" rows="3" placeholder="Σύντομη περιγραφή προϊόντος..."></textarea>
          </label>
        </div>
        <div class="modal-actions">
          <button class="button" type="button" id="modal-cancel"
                  style="background:#eee;color:#333;">Ακύρωση</button>
          <button class="button" type="button" id="modal-save">Αποθήκευση</button>
        </div>
      </div>
    </div>


    <script>
      // ── Products data (server-rendered) ────────────────────────
      let products = <%- productsJson %>;
      const canEdit = <%= permissions.canEditProducts ? 'true' : 'false' %>;

      // ── Render table ────────────────────────────────────────────
      function renderTable() {
        const tbody = document.getElementById('products-tbody');
        if (!products.length) {
          tbody.innerHTML = '<tr><td colspan="' + (canEdit ? 6 : 5) + '" style="color:#888;font-style:italic;">Δεν υπάρχουν προϊόντα ακόμα.</td></tr>';
          return;
        }
        tbody.innerHTML = products.map((p, i) => {
          const img = p.imageUrl
            ? '<img class="thumb" src="' + escHtml(p.imageUrl) + '" alt="" loading="lazy">'
            : '<span class="no-img"></span>';
          const editBtn = canEdit
            ? '<button class="btn-sm edit" type="button" onclick="openEdit(' + i + ')">Επεξεργασία</button> ' +
              '<button class="btn-sm del" type="button" onclick="deleteProduct(' + i + ')">Διαγραφή</button>'
            : '';
          return '<tr>' +
            '<td>' + img + '</td>' +
            '<td>' + escHtml(p.name || '') + '</td>' +
            '<td>' + (p.price !== undefined ? Number(p.price).toFixed(2) : '–') + '</td>' +
            '<td>' + escHtml(p.sku || '') + '</td>' +
            '<td>' + escHtml(p.categoryId || '') + '</td>' +
            (canEdit ? '<td>' + editBtn + '</td>' : '') +
            '</tr>';
        }).join('');
      }

      function escHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      // ── Modal logic ─────────────────────────────────────────────
      let editingIdx = -1; // -1 = new product

      const modal    = document.getElementById('product-modal');
      const fName    = document.getElementById('f-name');
      const fId      = document.getElementById('f-id');
      const fSku     = document.getElementById('f-sku');
      const fPrice   = document.getElementById('f-price');
      const fStock   = document.getElementById('f-stock');
      const fCat     = document.getElementById('f-category');
      const fImg     = document.getElementById('f-imageUrl');
      const fDesc    = document.getElementById('f-description');
      const mTitle   = document.getElementById('modal-title');

      function openAdd() {
        editingIdx = -1;
        mTitle.textContent = 'Νέο προϊόν';
        fName.value = ''; fId.value = ''; fSku.value = '';
        fPrice.value = ''; fStock.value = '1';
        fCat.value = ''; fImg.value = ''; fDesc.value = '';
        modal.classList.add('open');
        fName.focus();
      }

      function openEdit(i) {
        editingIdx = i;
        const p = products[i];
        mTitle.textContent = 'Επεξεργασία: ' + (p.name || '');
        fName.value  = p.name || '';
        fId.value    = p.id || '';
        fSku.value   = p.sku || '';
        fPrice.value = p.price !== undefined ? p.price : '';
        fStock.value = p.stock !== undefined ? p.stock : '';
        fCat.value   = p.categoryId || '';
        fImg.value   = p.imageUrl || '';
        fDesc.value  = p.description || '';
        modal.classList.add('open');
        fName.focus();
      }

      function closeModal() { modal.classList.remove('open'); }

      document.getElementById('modal-cancel').addEventListener('click', closeModal);
      modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

      document.getElementById('modal-save').addEventListener('click', function() {
        const name = fName.value.trim();
        const id   = fId.value.trim();
        if (!name || !id) {
          alert('Το όνομα και ο κωδικός είναι υποχρεωτικά.');
          return;
        }
        const product = {
          id,
          name,
          sku:         fSku.value.trim() || undefined,
          price:       parseFloat(fPrice.value) || 0,
          stock:       parseInt(fStock.value, 10) || 0,
          categoryId:  fCat.value || undefined,
          imageUrl:    fImg.value.trim() || undefined,
          description: fDesc.value.trim() || undefined
        };
        // Remove undefined fields
        Object.keys(product).forEach(k => product[k] === undefined && delete product[k]);

        if (editingIdx === -1) {
          products.push(product);
        } else {
          products[editingIdx] = product;
        }
        closeModal();
        renderTable();
      });

      function deleteProduct(i) {
        if (!confirm('Σίγουρα θέλετε να διαγράψετε το προϊόν "' + (products[i].name || i) + '";')) return;
        products.splice(i, 1);
        renderTable();
      }

      // ── Add button ──────────────────────────────────────────────
      const btnAdd = document.getElementById('btn-add-product');
      if (btnAdd) btnAdd.addEventListener('click', openAdd);

      // ── Serialize before submit ─────────────────────────────────
      const saveForm = document.getElementById('products-save-form');
      if (saveForm) {
        saveForm.addEventListener('submit', function() {
          document.getElementById('products-json-input').value = JSON.stringify(products);
        });
      }

      // ── Initial render ──────────────────────────────────────────
      renderTable();


      // ── Image upload ────────────────────────────────────────────
      const uploadForm   = document.getElementById('upload-form');
      const uploadResult = document.getElementById('upload-result');

      if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          uploadResult.textContent = 'Ανέβασμα σε εξέλιξη...';
          const formData = new FormData(uploadForm);
          const response = await fetch('/admin/upload-image', { method: 'POST', body: formData });
          const json = await response.json();
          if (json.ok) {
            uploadResult.innerHTML = 'Το ανέβασμα ολοκληρώθηκε! URL: <code>' + json.url + '</code>';
          } else {
            uploadResult.textContent = json.error || 'Σφάλμα κατά το ανέβασμα.';
          }
        });
      }

      // ── Color pickers ─────────────────────────────────────────────
      function bindColorPair(textId, pickerId) {
        const txt  = document.getElementById(textId);
        const pick = document.getElementById(pickerId);
        if (!txt || !pick) return;
        pick.addEventListener('input', () => { txt.value = pick.value; });
        txt.addEventListener('input', () => {
          if (/^#[0-9a-f]{6}$/i.test(txt.value)) pick.value = txt.value;
        });
      }
      bindColorPair('txt-primaryColor',       'cp-primaryColor');
      bindColorPair('txt-accentColor',        'cp-accentColor');
      bindColorPair('txt-themeMenuBg',        'cp-themeMenuBg');
      bindColorPair('txt-themeMenuText',      'cp-themeMenuText');
      bindColorPair('txt-themeMenuActiveBg',  'cp-themeMenuActiveBg');
      bindColorPair('txt-themeMenuActiveText','cp-themeMenuActiveText');

      // ── Logo upload (fills logoPath-input on success) ─────────────
      const logoUploadBtn    = document.getElementById('logo-upload-btn');
      const logoUploadStatus = document.getElementById('logo-upload-status');
      if (logoUploadBtn) {
        logoUploadBtn.addEventListener('click', async () => {
          const file = document.getElementById('logo-file').files[0];
          const pass = document.getElementById('logo-pass').value;
          if (!file) { logoUploadStatus.textContent = 'Επιλέξτε αρχείο.'; return; }
          if (!pass) { logoUploadStatus.textContent = 'Εισάγετε κωδικό.'; return; }
          logoUploadStatus.textContent = 'Ανέβασμα...';
          const fd = new FormData();
          fd.append('image', file);
          fd.append('password', pass);
          const r = await fetch('/admin/upload-image', { method: 'POST', body: fd });
          const j = await r.json();
          if (j.ok) {
            document.getElementById('logoPath-input').value = j.url;
            logoUploadStatus.innerHTML = 'Ανέβηκε! URL αυτόματα αντιγράφηκε στο πεδίο: <code>' + j.url + '</code>';
          } else {
            logoUploadStatus.textContent = j.error || 'Σφάλμα κατά το ανέβασμα.';
          }
        });
      }
    </script>
  </body>
</html>
