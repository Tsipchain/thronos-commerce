<!DOCTYPE html>
<html lang="<%= lang %>">
  <head>
    <meta charset="UTF-8" />
    <title><%= t('admin.tabTheme').split('&')[0].trim() %> – <%= config.storeName %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <style>
      :root {
        --primary-color: <%= config.primaryColor %>;
        --accent-color: <%= config.accentColor %>;
        --font-family: <%= config.fontFamily %>;
        --menu-bg: <%= (config.theme && config.theme.menuBg) || '#111' %>;
        --menu-text: <%= (config.theme && config.theme.menuText) || '#fff' %>;
        --menu-active-bg: <%= (config.theme && config.theme.menuActiveBg) || '#f06292' %>;
        --menu-active-text: <%= (config.theme && config.theme.menuActiveText) || '#fff' %>;
        --button-radius: <%= (config.theme && config.theme.buttonRadius) || '4px' %>;
      }

      /* ── Full-Ops banner ── */
      .fullops-banner {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 6px;
        padding: 14px 18px;
        margin-bottom: 20px;
        font-size: 0.95rem;
        line-height: 1.5;
        color: #5a4200;
      }

      /* ── Products table & modal ── */
      .products-table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
      .products-table th, .products-table td {
        text-align: left; padding: 8px 10px;
        border-bottom: 1px solid #e0e0e0; font-size: 0.88rem;
      }
      .products-table th { background: #f5f5f5; font-weight: 600; }
      .products-table .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 4px; }
      .products-table .no-img { width: 48px; height: 48px; background: #eee; border-radius: 4px; display: inline-block; }
      .btn-sm { padding: 4px 10px; font-size: 0.8rem; border-radius: 4px; cursor: pointer;
                border: 1px solid #ccc; background: #fff; }
      .btn-sm.edit { border-color: var(--accent-color); color: var(--accent-color); }
      .btn-sm.del  { border-color: #e57373; color: #e57373; }
      .btn-sm:disabled { opacity: 0.4; cursor: not-allowed; }

      /* modal overlay */
      .modal-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(0,0,0,.45); z-index: 900;
        align-items: center; justify-content: center;
      }
      .modal-overlay.open { display: flex; }
      .modal-box {
        background: #fff; border-radius: 8px; padding: 28px 28px 20px;
        width: min(520px, 95vw); max-height: 90vh; overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,.18);
      }
      .modal-box h3 { margin-top: 0; }
      .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .modal-grid .full { grid-column: 1 / -1; }
      .modal-grid label { display: flex; flex-direction: column; gap: 4px; font-size: 0.86rem; }
      .modal-grid input, .modal-grid textarea, .modal-grid select {
        padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem;
      }
      .modal-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }

      /* helper text */
      .helper { font-size: 0.82rem; color: #666; margin: 0 0 12px; }

      /* password row for product save */
      .save-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
      .save-row input[type=password] { flex: 1 1 180px; }

      /* ── Shipping & Payment table ── */
      .sp-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
      .sp-table th, .sp-table td {
        padding: 8px 10px; text-align: left;
        border-bottom: 1px solid #e0e0e0; font-size: 0.87rem;
      }
      .sp-table th { background: #f5f5f5; font-weight: 600; white-space: nowrap; }
      .sp-table input[type=text],
      .sp-table input[type=number] {
        width: 100%; box-sizing: border-box;
        padding: 5px 7px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.87rem;
      }
      .sp-table input:read-only { background: #f9f9f9; color: #888; cursor: not-allowed; }
      .sp-badge {
        display: inline-block; background: #e8f4fd; color: #1a73b8;
        border-radius: 3px; padding: 1px 6px; font-size: 0.76rem; font-family: monospace;
      }

      /* ── Color picker pairs ── */
      .color-field { display: flex; gap: 6px; align-items: center; }
      .color-field input[type=text]  { flex: 1; }
      .color-field input[type=color] {
        width: 36px; height: 34px; padding: 2px;
        border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: #fff;
        flex-shrink: 0;
      }
      .color-field input[type=color]:disabled { opacity: 0.4; cursor: not-allowed; }

      /* ── Logo upload inline ── */
      .logo-upload-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 4px; }
      .logo-upload-row input[type=file] { flex: 1 1 160px; font-size: 0.82rem; }
      .btn-xs { padding: 5px 12px; font-size: 0.8rem; background: #eee;
                border: 1px solid #ccc; border-radius: 4px; cursor: pointer; white-space: nowrap; }
      #logo-upload-status { font-size: 0.8rem; color: #555; margin-top: 4px; }

      /* ── Notifications section ── */
      .notif-section { margin-top: 22px; padding-top: 16px; border-top: 1px dashed #ddd; }
      .notif-section h3 { margin: 0 0 4px; }
      .checkbox-label { display: flex !important; flex-direction: row !important;
                        align-items: center; gap: 8px; cursor: pointer; }
      .checkbox-label input[type=checkbox] { width: auto; margin: 0; }
    </style>
  </head>
  <body>
    <header>
      <h1><%= t('admin.headerTitle') %></h1>
      <p class="subtitle">
        <%= t('admin.store') %>: <strong><%= tenant.id %></strong>
        &nbsp;·&nbsp;
        <%= t('admin.package') %>: <strong><%= tenant.supportTier %></strong>
        &nbsp;·&nbsp;
        <a href="/admin" style="font-size:0.85rem"><%= t('admin.settingsLink') %></a>
        &nbsp;|&nbsp;
        <a href="/admin/orders" style="font-size:0.85rem"><%= t('admin.ordersLink') %></a>
        &nbsp;|&nbsp;
        <a href="/" style="font-size:0.85rem"><%= t('admin.storefrontLink') %></a>
      </p>
    </header>

    <main class="admin-layout">

      <%# ── Full-Ops banner ── %>
      <% if (tenant.supportTier === 'FULL_OPS_START') { %>
      <div class="fullops-banner">
        <strong><%= t('admin.fullOpsBanner') %></strong><br>
        <%= t('admin.fullOpsText') %>
      </div>
      <% } %>

      <%# ── Flash messages ── %>
      <% if (message) { %><p class="admin-msg success"><%= message %></p><% } %>
      <% if (error)   { %><p class="admin-msg error"><%= error %></p><% } %>

      <nav class="admin-tabs">
        <a href="#tab-theme"><%= t('admin.tabTheme') %></a>
        <a href="#tab-categories"><%= t('admin.tabCategories') %></a>
        <a href="#tab-products"><%= t('admin.tabProducts') %></a>
        <a href="#tab-upload"><%= t('admin.tabImages') %></a>
        <a href="#tab-shipping"><%= t('admin.tabShipping') %></a>
        <a href="#tab-notifications"><%= t('admin.tabNotifications') %></a>
        <a href="/admin/orders"><%= t('admin.tabOrders') %></a>
      </nav>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 1 – THEME / SETTINGS                                %>
      <%# ══════════════════════════════════════════════════════════ %>
      <form id="tab-theme" class="admin-block" method="POST" action="/admin/settings">
        <h2><%= t('admin.themeTitle') %></h2>
        <p class="helper"><%= t('admin.themeHelper') %></p>

        <label><span><%= t('admin.storeName') %></span>
          <input type="text" name="storeName" value="<%= config.storeName %>"
                 <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>

        <label><span><%= t('admin.primaryColor') %></span>
          <div class="color-field">
            <input type="text" name="primaryColor" id="txt-primaryColor"
                   value="<%= config.primaryColor %>" placeholder="#222222"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-primaryColor" value="<%= config.primaryColor || '#222222' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span><%= t('admin.accentColor') %></span>
          <div class="color-field">
            <input type="text" name="accentColor" id="txt-accentColor"
                   value="<%= config.accentColor %>" placeholder="#00ff88"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-accentColor" value="<%= config.accentColor || '#00ff88' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span><%= t('admin.fontFamily') %></span>
          <select name="fontFamily" <%= permissions.canEditSettings ? '' : 'disabled' %>>
            <option value="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
              <%= config.fontFamily.includes('system-ui') ? 'selected' : '' %>>System UI (προεπιλογή)</option>
            <option value="'Roboto', Arial, sans-serif"
              <%= config.fontFamily.includes('Roboto') ? 'selected' : '' %>>Roboto</option>
            <option value="'Segoe UI', system-ui, sans-serif"
              <%= config.fontFamily.includes('Segoe UI') && !config.fontFamily.includes('system-ui, -apple') ? 'selected' : '' %>>Segoe UI</option>
          </select>
        </label>

        <label><span><%= t('admin.heroTextLabel') %></span>
          <textarea name="heroText" rows="3"
                    <%= permissions.canEditSettings ? '' : 'readonly' %>><%= config.heroText %></textarea>
        </label>

        <label><span><%= t('admin.web3DomainLabel') %></span>
          <input type="text" name="web3Domain" value="<%= config.web3Domain %>"
                 placeholder="π.χ. mystore.thr" <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>

        <label><span><%= t('admin.logoPath') %></span>
          <input type="text" name="logoPath" id="logoPath-input" value="<%= config.logoPath %>"
                 placeholder="/logo.svg" <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>
        <% if (permissions.canUploadMedia) { %>
        <div style="margin:-4px 0 14px;">
          <p class="helper" style="margin-bottom:5px;"><%= t('admin.uploadLogoHelper') %></p>
          <div class="logo-upload-row">
            <input type="file" id="logo-file" accept="image/*" />
            <input type="password" id="logo-pass" placeholder="<%= t('admin.logoPassPlaceholder') %>" style="width:130px;" />
            <button type="button" class="btn-xs" id="logo-upload-btn"><%= t('admin.uploadLogoBtn') %></button>
          </div>
          <p id="logo-upload-status"></p>
        </div>
        <% } %>

        <h3><%= t('admin.menuColors') %></h3>
        <p class="helper"><%= t('admin.menuColorsHelper') %></p>

        <label><span><%= t('admin.menuBg') %></span>
          <div class="color-field">
            <input type="text" name="themeMenuBg" id="txt-themeMenuBg"
                   value="<%= (config.theme && config.theme.menuBg) || '#111111' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuBg"
                   value="<%= (config.theme && config.theme.menuBg) || '#111111' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span><%= t('admin.menuText') %></span>
          <div class="color-field">
            <input type="text" name="themeMenuText" id="txt-themeMenuText"
                   value="<%= (config.theme && config.theme.menuText) || '#ffffff' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuText"
                   value="<%= (config.theme && config.theme.menuText) || '#ffffff' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span><%= t('admin.menuActiveBg') %></span>
          <div class="color-field">
            <input type="text" name="themeMenuActiveBg" id="txt-themeMenuActiveBg"
                   value="<%= (config.theme && config.theme.menuActiveBg) || '#f06292' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuActiveBg"
                   value="<%= (config.theme && config.theme.menuActiveBg) || '#f06292' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span><%= t('admin.menuActiveText') %></span>
          <div class="color-field">
            <input type="text" name="themeMenuActiveText" id="txt-themeMenuActiveText"
                   value="<%= (config.theme && config.theme.menuActiveText) || '#ffffff' %>"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
            <input type="color" id="cp-themeMenuActiveText"
                   value="<%= (config.theme && config.theme.menuActiveText) || '#ffffff' %>"
                   title="Επιλογή χρώματος" <%= permissions.canEditSettings ? '' : 'disabled' %> />
          </div>
        </label>

        <label><span><%= t('admin.buttonRadius') %></span>
          <input type="text" name="themeButtonRadius"
                 value="<%= (config.theme && config.theme.buttonRadius) || '4px' %>"
                 placeholder="4px" <%= permissions.canEditSettings ? '' : 'readonly' %> />
        </label>

        <%# ── Ειδοποιήσεις ── %>
        <div class="notif-section">
          <h3><%= t('admin.notifEmail') %></h3>
          <p class="helper"><%= t('admin.notifEmailHelper') %></p>

          <label><span><%= t('admin.notifEmailLabel') %> <small style="color:#999">(<%= t('admin.notifEmailHint') %>)</small></span>
            <textarea name="notificationEmails" rows="3"
                      placeholder="owner@myshop.gr&#10;backup@myshop.gr"
                      <%= permissions.canEditSettings ? '' : 'readonly' %>><%= (config.notificationEmails || []).join('\n') %></textarea>
          </label>

          <label class="checkbox-label">
            <input type="checkbox" name="notificationCcCustomer"
                   <%= (config.notificationCcCustomer) ? 'checked' : '' %>
                   <%= permissions.canEditSettings ? '' : 'disabled' %> />
            <span><%= t('admin.notifCcCustomer') %></span>
          </label>

          <label><span><%= t('admin.notifFromName') %></span>
            <input type="text" name="notificationFromName"
                   value="<%= config.notificationFromName || '' %>"
                   placeholder="π.χ. FashionMM Store"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
          </label>

          <h3 style="margin-top:18px;"><%= t('admin.notifWebhook') %></h3>
          <p class="helper"><%= t('admin.notifWebhookHelper') %></p>

          <label><span><%= t('admin.webhookUrl') %></span>
            <input type="text" name="notificationWebhookUrl"
                   value="<%= config.notificationWebhookUrl || '' %>"
                   placeholder="https://myhook.example.com/orders"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
          </label>

          <label><span><%= t('admin.webhookSecret') %> <small style="color:#999">(<%= t('admin.webhookSecretHint') %>)</small></span>
            <input type="text" name="notificationWebhookSecret"
                   value="<%= config.notificationWebhookSecret || '' %>"
                   placeholder="mysecret123"
                   <%= permissions.canEditSettings ? '' : 'readonly' %> />
          </label>
        </div>

        <label><span><%= t('admin.adminPass') %></span>
          <input type="password" name="password"
                 <%= permissions.canEditSettings ? 'required' : 'disabled' %> />
        </label>

        <button type="submit" class="button" <%= permissions.canEditSettings ? '' : 'disabled' %>>
          <%= t('admin.saveSettings') %>
        </button>
        <% if (!permissions.canEditSettings) { %>
          <p class="helper" style="margin-top:8px;"><%= t('admin.fullOpsManagedNote') %></p>
        <% } %>
      </form>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 2 – CATEGORIES                                      %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-categories" class="admin-block">
        <h2><%= t('admin.categoriesTitle') %></h2>
        <p class="helper"><%= t('admin.categoriesHelper') %></p>

        <table class="admin-table">
          <thead>
            <tr>
              <th><%= t('admin.catColId') %></th>
              <th><%= t('admin.catColName') %></th>
              <th><%= t('admin.catColSlug') %></th>
              <th><%= t('admin.catColParent') %></th>
              <th><%= t('admin.catColAction') %></th>
            </tr>
          </thead>
          <tbody>
            <% categories.forEach(function(cat){ %>
              <tr>
                <td><code><%= cat.id %></code></td>
                <td><%= cat.name %></td>
                <td><%= cat.slug %></td>
                <td><%= cat.parentId ? cat.parentId : '–' %></td>
                <td>
                  <form method="POST" action="/admin/categories/delete" class="inline-form">
                    <input type="hidden" name="categoryId" value="<%= cat.id %>" />
                    <input type="password" name="password" placeholder="Κωδικός"
                           <%= permissions.canEditCategories ? 'required' : 'disabled' %> />
                    <button type="submit" class="button danger"
                            <%= permissions.canEditCategories ? '' : 'disabled' %>><%= t('admin.catDelete') %></button>
                  </form>
                </td>
              </tr>
            <% }) %>
            <% if (categories.length === 0) { %>
              <tr><td colspan="4" style="color:#888;font-style:italic;"><%= t('admin.catNone') %></td></tr>
            <% } %>
          </tbody>
        </table>

        <% if (permissions.canEditCategories) { %>
        <form method="POST" action="/admin/categories/add" class="admin-subform">
          <h3><%= t('admin.catAddTitle') %></h3>
          <p class="helper"><%= t('admin.catAddHelper') %></p>
          <input type="text" name="id" placeholder="Κωδικός (π.χ. bags)" required />
          <input type="text" name="name" placeholder="Όνομα (π.χ. Τσάντες)" required />
          <input type="text" name="slug" placeholder="Slug (π.χ. tsantes)" required />
          <select name="parentId">
            <option value=""><%= t('admin.catNoParent') %></option>
            <% categories.forEach(function(cat){ %>
              <option value="<%= cat.id %>"><%= cat.name %> (<%= cat.id %>)</option>
            <% }) %>
          </select>
          <input type="password" name="password" placeholder="Κωδικός διαχειριστή" required />
          <button type="submit" class="button"><%= t('admin.catAddBtn') %></button>
        </form>

        <form method="POST" action="/admin/categories/update" class="admin-subform">
          <h3><%= t('admin.catUpdateTitle') %></h3>
          <select name="categoryId">
            <% categories.forEach(function(cat){ %>
              <option value="<%= cat.id %>"><%= cat.name %> (<%= cat.id %>)</option>
            <% }) %>
          </select>
          <input type="text" name="name" placeholder="Νέο όνομα" required />
          <input type="text" name="slug" placeholder="Νέο slug" required />
          <select name="parentId">
            <option value=""><%= t('admin.catNoParent') %></option>
            <% categories.forEach(function(cat){ %>
              <option value="<%= cat.id %>"><%= cat.name %> (<%= cat.id %>)</option>
            <% }) %>
          </select>
          <input type="password" name="password" placeholder="Κωδικός διαχειριστή" required />
          <button type="submit" class="button"><%= t('admin.catUpdateBtn') %></button>
        </form>
        <% } else { %>
          <p class="helper"><%= t('admin.catManagedNote') %></p>
        <% } %>
      </section>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 3 – PRODUCTS (table + modal editor)                 %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-products" class="admin-block">
        <h2><%= t('admin.productsTitle') %></h2>
        <p class="helper">
          <%= t('admin.productsHelper') %>
          <% if (!permissions.canEditProducts) { %>
            <br><em><%= t('admin.productsManagedNote') %></em>
          <% } %>
        </p>

        <% if (permissions.canEditProducts) { %>
          <button class="button" id="btn-add-product" type="button"><%= t('admin.addProduct') %></button>
        <% } %>

        <table class="products-table" id="products-table">
          <thead>
            <tr>
              <th></th>
              <th><%= t('admin.colName') %></th>
              <th><%= t('admin.colPrice') %></th>
              <th><%= t('admin.colSku') %></th>
              <th><%= t('admin.colCategory') %></th>
              <% if (permissions.canEditProducts) { %><th><%= t('admin.colActions') %></th><% } %>
            </tr>
          </thead>
          <tbody id="products-tbody">
            <%# Rendered by JS below %>
          </tbody>
        </table>

        <%# Hidden form that submits the serialized JSON array to the backend %>
        <form id="products-save-form" method="POST" action="/admin/products">
          <input type="hidden" name="productsJson" id="products-json-input" />
          <% if (permissions.canEditProducts) { %>
          <div class="save-row">
            <label style="flex:1 1 auto;font-size:0.86rem;">
              <%= t('admin.savePassLabel') %>
            </label>
            <input type="password" name="password" required placeholder="<%= t('admin.adminPass') %>" />
            <button type="submit" class="button"><%= t('admin.saveAll') %></button>
          </div>
          <% } %>
        </form>
      </section>


      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 4 – IMAGE UPLOAD                                    %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-upload" class="admin-block">
        <h2><%= t('admin.imagesTitle') %></h2>
        <p class="helper"><%= t('admin.imagesHelper') %></p>
        <form id="upload-form" enctype="multipart/form-data">
          <input type="file" name="image" accept="image/*"
                 <%= permissions.canUploadMedia ? '' : 'disabled' %> required />
          <input type="password" name="password" placeholder="Κωδικός διαχειριστή"
                 <%= permissions.canUploadMedia ? 'required' : 'disabled' %> />
          <button class="button" type="submit"
                  <%= permissions.canUploadMedia ? '' : 'disabled' %>><%= t('admin.uploadBtn') %></button>
        </form>
        <p id="upload-result"></p>
        <% if (!permissions.canUploadMedia) { %>
          <p class="helper"><%= t('admin.imagesManagedNote') %></p>
        <% } %>
      </section>

      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 5 – SHIPPING & PAYMENT                              %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-shipping" class="admin-block">
        <h2><%= t('admin.shippingTitle') %></h2>
        <p class="helper"><%= t('admin.shippingHelper') %></p>

        <% if (!permissions.canEditSettings) { %>
          <p class="helper"><%= t('admin.shippingManagedNote') %></p>
        <% } %>

        <form method="POST" action="/admin/shipping-payment">

          <%# ── Shipping options ── %>
          <h3><%= t('admin.shippingOptionsTitle') %></h3>
          <% if ((config.shippingOptions || []).length === 0) { %>
            <p class="helper" style="color:#888;"><%= t('admin.shippingNone') %></p>
          <% } else { %>
          <table class="sp-table">
            <thead>
              <tr>
                <th><%= t('admin.shipColId') %></th>
                <th><%= t('admin.shipColLabel') %></th>
                <th><%= t('admin.shipColBase') %></th>
                <th><%= t('admin.shipColCodFee') %></th>
                <th><%= t('admin.shipColAllowed') %></th>
              </tr>
            </thead>
            <tbody>
              <% (config.shippingOptions || []).forEach(function(opt, i) { %>
              <tr>
                <td><span class="sp-badge"><%= opt.id %></span></td>
                <td>
                  <input type="text" name="ship_label_<%= i %>"
                         value="<%= opt.label || '' %>"
                         <%= permissions.canEditSettings ? 'required' : 'readonly' %> />
                </td>
                <td>
                  <input type="number" name="ship_base_<%= i %>"
                         value="<%= opt.base !== undefined ? opt.base : 0 %>"
                         min="0" step="0.01"
                         <%= permissions.canEditSettings ? '' : 'readonly' %> />
                </td>
                <td>
                  <input type="number" name="ship_codFee_<%= i %>"
                         value="<%= opt.codFee !== undefined ? opt.codFee : 0 %>"
                         min="0" step="0.01"
                         <%= permissions.canEditSettings ? '' : 'readonly' %> />
                </td>
                <td>
                  <% (opt.allowedPaymentMethods || []).forEach(function(pm) { %>
                    <span class="sp-badge"><%= pm %></span>
                  <% }) %>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
          <% } %>
          <p class="helper" style="margin-top:6px;"><%= t('admin.shipCostHelper') %></p>

          <%# ── Payment options ── %>
          <h3><%= t('admin.paymentOptionsTitle') %></h3>
          <% if ((config.paymentOptions || []).length === 0) { %>
            <p class="helper" style="color:#888;"><%= t('admin.paymentNone') %></p>
          <% } else { %>
          <table class="sp-table">
            <thead>
              <tr>
                <th><%= t('admin.payColId') %></th>
                <th><%= t('admin.payColLabel') %></th>
                <th><%= t('admin.payColType') %></th>
              </tr>
            </thead>
            <tbody>
              <% (config.paymentOptions || []).forEach(function(opt, i) { %>
              <tr>
                <td><span class="sp-badge"><%= opt.id %></span></td>
                <td>
                  <input type="text" name="pay_label_<%= i %>"
                         value="<%= opt.label || '' %>"
                         <%= permissions.canEditSettings ? 'required' : 'readonly' %> />
                </td>
                <td><span class="sp-badge"><%= opt.type || '–' %></span></td>
              </tr>
              <% }) %>
            </tbody>
          </table>
          <% } %>
          <% if (permissions.canEditSettings) { %>
          <div class="save-row">
            <label style="flex:1 1 auto;font-size:0.86rem;"><%= t('admin.adminPass') %>:</label>
            <input type="password" name="password" required placeholder="<%= t('admin.adminPass') %>" />
            <button type="submit" class="button"><%= t('admin.shippingSave') %></button>
          </div>
          <% } %>

        </form>
      </section>

      <%# ══════════════════════════════════════════════════════════ %>
      <%#   TAB 7 – NOTIFICATIONS                                   %>
      <%# ══════════════════════════════════════════════════════════ %>
      <section id="tab-notifications" class="admin-block">
        <h2><%= t('admin.notificationsTitle') %></h2>
        <p class="helper"><%= t('admin.notificationsHelper') %></p>

        <div class="notifications-skeleton">
          <table class="sp-table" style="opacity:.5;">
            <thead>
              <tr>
                <th><%= t('admin.notifColDate') %></th>
                <th><%= t('admin.notifColSubject') %></th>
                <th><%= t('admin.notifColRecipients') %></th>
                <th><%= t('admin.notifColStatus') %></th>
                <th><%= t('admin.notifColHash') %></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td colspan="5" style="text-align:center;color:#aaa;font-style:italic;padding:24px 0;">
                  <%= t('admin.notificationsComingSoon') %>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

    </main>


    <%# ══════════════════════════════════════════════════════════ %>
    <%#   PRODUCT MODAL                                           %>
    <%# ══════════════════════════════════════════════════════════ %>
    <div class="modal-overlay" id="product-modal">
      <div class="modal-box">
        <h3 id="modal-title"><%= t('admin.modalNewProduct') %></h3>
        <div class="modal-grid">
          <label class="full"><span><%= t('admin.modalProductName') %></span>
            <input type="text" id="f-name" placeholder="π.χ. Δερμάτινη τσάντα" />
          </label>
          <label><span><%= t('admin.modalProductId') %></span>
            <input type="text" id="f-id" placeholder="π.χ. bag-001" />
          </label>
          <label><span><%= t('admin.modalSku') %></span>
            <input type="text" id="f-sku" placeholder="π.χ. SKU-123" />
          </label>
          <label><span><%= t('admin.modalPrice') %></span>
            <input type="number" id="f-price" min="0" step="0.01" placeholder="0.00" />
          </label>
          <label><span><%= t('admin.modalStock') %></span>
            <input type="number" id="f-stock" min="0" step="1" placeholder="0" />
          </label>
          <label class="full"><span><%= t('admin.modalCategory') %></span>
            <select id="f-category">
              <option value=""><%= t('admin.modalNoCat') %></option>
              <% categories.forEach(function(cat){ %>
                <option value="<%= cat.id %>"><%= cat.name %></option>
              <% }) %>
            </select>
          </label>
          <label class="full"><span><%= t('admin.modalImageUrl') %></span>
            <input type="text" id="f-imageUrl" placeholder="/tenants/.../media/photo.jpg" />
          </label>
          <label class="full"><span><%= t('admin.modalDescription') %></span>
            <textarea id="f-description" rows="3" placeholder="Σύντομη περιγραφή προϊόντος..."></textarea>
          </label>
          <label class="full"><span><%= t('admin.modalSeoTitle') %></span>
            <input type="text" id="f-seoTitle" placeholder="<%= t('admin.modalSeoTitlePlaceholder') %>" />
          </label>
          <label class="full"><span><%= t('admin.modalSeoDescription') %></span>
            <input type="text" id="f-seoDescription" placeholder="<%= t('admin.modalSeoDescPlaceholder') %>" />
          </label>
          <label class="full"><span><%= t('admin.modalGallery') %></span>
            <textarea id="f-gallery" rows="3" placeholder="<%= t('admin.modalGalleryPlaceholder') %>"></textarea>
            <small style="color:#888;font-size:0.78rem;"><%= t('admin.modalGalleryHelper') %></small>
          </label>
        </div>
        <div class="modal-actions">
          <button class="button" type="button" id="modal-cancel"
                  style="background:#eee;color:#333;"><%= t('admin.modalCancel') %></button>
          <button class="button" type="button" id="modal-save"><%= t('admin.modalSave') %></button>
        </div>
      </div>
    </div>


    <script>
      // ── i18n strings for JS ────────────────────────────────────
      const i18nJs = {
        noProducts:    '<%- t("admin.noProductsYet") %>',
        newProduct:    '<%- t("admin.modalNewProduct") %>',
        editPrefix:    '<%- t("admin.modalEditPrefix") %>',
        editBtn:       '<%- t("admin.editProduct") %>',
        deleteBtn:     '<%- t("admin.deleteProduct") %>',
        nameRequired:  '<%- t("admin.jsNameIdRequired") %>',
        uploading:     '<%- t("admin.jsUploading") %>',
        uploadOk:      '<%- t("admin.jsUploadComplete") %>',
        uploadErr:     '<%- t("admin.jsUploadError") %>',
        logoOk:        '<%- t("admin.jsLogoUploaded") %>',
        selectFile:    '<%- t("admin.jsSelectFile") %>',
        enterPass:     '<%- t("admin.jsEnterPassword") %>'
      };

      // ── Products data (server-rendered) ────────────────────────
      let products = <%- productsJson %>;
      const canEdit = <%= permissions.canEditProducts ? 'true' : 'false' %>;

      // ── Render table ────────────────────────────────────────────
      function renderTable() {
        const tbody = document.getElementById('products-tbody');
        if (!products.length) {
          tbody.innerHTML = '<tr><td colspan="' + (canEdit ? 6 : 5) + '" style="color:#888;font-style:italic;">' + i18nJs.noProducts + '</td></tr>';
          return;
        }
        tbody.innerHTML = products.map((p, i) => {
          const img = p.imageUrl
            ? '<img class="thumb" src="' + escHtml(p.imageUrl) + '" alt="" loading="lazy">'
            : '<span class="no-img"></span>';
          const editBtn = canEdit
            ? '<button class="btn-sm edit" type="button" onclick="openEdit(' + i + ')">' + i18nJs.editBtn + '</button> ' +
              '<button class="btn-sm del" type="button" onclick="deleteProduct(' + i + ')">' + i18nJs.deleteBtn + '</button>'
            : '';
          return '<tr>' +
            '<td>' + img + '</td>' +
            '<td>' + escHtml(p.name || '') + '</td>' +
            '<td>' + (p.price !== undefined ? Number(p.price).toFixed(2) : '–') + '</td>' +
            '<td>' + escHtml(p.sku || '') + '</td>' +
            '<td>' + escHtml(p.categoryId || '') + '</td>' +
            (canEdit ? '<td>' + editBtn + '</td>' : '') +
            '</tr>';
        }).join('');
      }

      function escHtml(s) {
        return String(s)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      // ── Modal logic ─────────────────────────────────────────────
      let editingIdx = -1; // -1 = new product

      const modal      = document.getElementById('product-modal');
      const fName      = document.getElementById('f-name');
      const fId        = document.getElementById('f-id');
      const fSku       = document.getElementById('f-sku');
      const fPrice     = document.getElementById('f-price');
      const fStock     = document.getElementById('f-stock');
      const fCat       = document.getElementById('f-category');
      const fImg       = document.getElementById('f-imageUrl');
      const fDesc      = document.getElementById('f-description');
      const fSeoTitle  = document.getElementById('f-seoTitle');
      const fSeoDesc   = document.getElementById('f-seoDescription');
      const fGallery   = document.getElementById('f-gallery');
      const mTitle     = document.getElementById('modal-title');

      function openAdd() {
        editingIdx = -1;
        mTitle.textContent = i18nJs.newProduct;
        fName.value = ''; fId.value = ''; fSku.value = '';
        fPrice.value = ''; fStock.value = '1';
        fCat.value = ''; fImg.value = ''; fDesc.value = '';
        fSeoTitle.value = ''; fSeoDesc.value = ''; fGallery.value = '';
        modal.classList.add('open');
        fName.focus();
      }

      function openEdit(i) {
        editingIdx = i;
        const p = products[i];
        mTitle.textContent = i18nJs.editPrefix + (p.name || '');
        fName.value     = p.name || '';
        fId.value       = p.id || '';
        fSku.value      = p.sku || '';
        fPrice.value    = p.price !== undefined ? p.price : '';
        fStock.value    = p.stock !== undefined ? p.stock : '';
        fCat.value      = p.categoryId || '';
        fImg.value      = p.imageUrl || '';
        fDesc.value     = p.description || '';
        fSeoTitle.value = p.seoTitle || '';
        fSeoDesc.value  = p.seoDescription || '';
        fGallery.value  = Array.isArray(p.gallery) ? p.gallery.join('\n') : '';
        modal.classList.add('open');
        fName.focus();
      }

      function closeModal() { modal.classList.remove('open'); }

      document.getElementById('modal-cancel').addEventListener('click', closeModal);
      modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });

      document.getElementById('modal-save').addEventListener('click', function() {
        const name = fName.value.trim();
        const id   = fId.value.trim();
        if (!name || !id) {
          alert(i18nJs.nameRequired);
          return;
        }
        const galleryRaw = fGallery.value.split('\n').map(l => l.trim()).filter(Boolean);
        const product = {
          id,
          name,
          sku:            fSku.value.trim() || undefined,
          price:          parseFloat(fPrice.value) || 0,
          stock:          parseInt(fStock.value, 10) || 0,
          categoryId:     fCat.value || undefined,
          imageUrl:       fImg.value.trim() || undefined,
          description:    fDesc.value.trim() || undefined,
          seoTitle:       fSeoTitle.value.trim() || undefined,
          seoDescription: fSeoDesc.value.trim() || undefined,
          gallery:        galleryRaw.length ? galleryRaw : undefined
        };
        // Remove undefined fields
        Object.keys(product).forEach(k => product[k] === undefined && delete product[k]);

        if (editingIdx === -1) {
          products.push(product);
        } else {
          products[editingIdx] = product;
        }
        closeModal();
        renderTable();
      });

      function deleteProduct(i) {
        if (!confirm(i18nJs.editPrefix.replace(': ','') + ' "' + (products[i].name || i) + '" ;')) return;
        products.splice(i, 1);
        renderTable();
      }

      // ── Add button ──────────────────────────────────────────────
      const btnAdd = document.getElementById('btn-add-product');
      if (btnAdd) btnAdd.addEventListener('click', openAdd);

      // ── Serialize before submit ─────────────────────────────────
      const saveForm = document.getElementById('products-save-form');
      if (saveForm) {
        saveForm.addEventListener('submit', function() {
          document.getElementById('products-json-input').value = JSON.stringify(products);
        });
      }

      // ── Initial render ──────────────────────────────────────────
      renderTable();


      // ── Image upload ────────────────────────────────────────────
      const uploadForm   = document.getElementById('upload-form');
      const uploadResult = document.getElementById('upload-result');

      if (uploadForm) {
        uploadForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          uploadResult.textContent = i18nJs.uploading;
          const formData = new FormData(uploadForm);
          const response = await fetch('/admin/upload-image', { method: 'POST', body: formData });
          const json = await response.json();
          if (json.ok) {
            uploadResult.innerHTML = i18nJs.uploadOk + '<code>' + json.url + '</code>';
          } else {
            uploadResult.textContent = json.error || i18nJs.uploadErr;
          }
        });
      }

      // ── Color pickers ─────────────────────────────────────────────
      function bindColorPair(textId, pickerId) {
        const txt  = document.getElementById(textId);
        const pick = document.getElementById(pickerId);
        if (!txt || !pick) return;
        pick.addEventListener('input', () => { txt.value = pick.value; });
        txt.addEventListener('input', () => {
          if (/^#[0-9a-f]{6}$/i.test(txt.value)) pick.value = txt.value;
        });
      }
      bindColorPair('txt-primaryColor',       'cp-primaryColor');
      bindColorPair('txt-accentColor',        'cp-accentColor');
      bindColorPair('txt-themeMenuBg',        'cp-themeMenuBg');
      bindColorPair('txt-themeMenuText',      'cp-themeMenuText');
      bindColorPair('txt-themeMenuActiveBg',  'cp-themeMenuActiveBg');
      bindColorPair('txt-themeMenuActiveText','cp-themeMenuActiveText');

      // ── Logo upload (fills logoPath-input on success) ─────────────
      const logoUploadBtn    = document.getElementById('logo-upload-btn');
      const logoUploadStatus = document.getElementById('logo-upload-status');
      if (logoUploadBtn) {
        logoUploadBtn.addEventListener('click', async () => {
          const file = document.getElementById('logo-file').files[0];
          const pass = document.getElementById('logo-pass').value;
          if (!file) { logoUploadStatus.textContent = i18nJs.selectFile; return; }
          if (!pass) { logoUploadStatus.textContent = i18nJs.enterPass; return; }
          logoUploadStatus.textContent = i18nJs.uploading;
          const fd = new FormData();
          fd.append('image', file);
          fd.append('password', pass);
          const r = await fetch('/admin/upload-image', { method: 'POST', body: fd });
          const j = await r.json();
          if (j.ok) {
            document.getElementById('logoPath-input').value = j.url;
            logoUploadStatus.innerHTML = i18nJs.logoOk + '<code>' + j.url + '</code>';
          } else {
            logoUploadStatus.textContent = j.error || i18nJs.uploadErr;
          }
        });
      }
    </script>
  </body>
</html>
